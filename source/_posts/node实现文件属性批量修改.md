---
layout: post
title: nodeå®ç°æ–‡ä»¶å±æ€§æ‰¹é‡ä¿®æ”¹(æ—¶é—´å±æ€§)
tags: node
category: å°å·¥å…·
description: åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ–‡ä»¶çš„åˆ›å»ºæ—¶é—´å’Œä¿®æ”¹æ—¶é—´æ˜¯ç³»ç»Ÿè‡ªå·±è®¾å®šçš„ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿®æ”¹è¯¥çš„ã€‚ä½†æˆ‘ä»¬æœ‰æ—¶ä¸ºäº†æŸç§ç‰¹æ®Šéœ€è¦ï¼Œä¸ºäº†ä¸è®©åˆ«äººä¸€çœ¼çœ‹å‡ºæ–‡ä»¶å·²ç»ç»™ä¿®æ”¹äº†ï¼Œæˆ‘ä»¬åˆéœ€è¦ä¿®æ”¹æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´å’Œä¿®æ”¹æ—¶é—´ã€‚é‚£ä¹ˆå¦‚ä½•ä¿®æ”¹æ–‡ä»¶å¤¹æ—¶é—´ï¼Œå¦‚ä½•ä¿®æ”¹æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ï¼Œå¦‚ä½•æ‰¹é‡ä¿®æ”¹æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´å’Œè®¿é—®æ—¶é—´å‘¢ï¼Ÿ
date: 2020/06/17
---

# å‰è¨€

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ–‡ä»¶çš„`åˆ›å»ºæ—¶é—´`å’Œ`ä¿®æ”¹æ—¶é—´`æ˜¯ç³»ç»Ÿè‡ªå·±è®¾å®šçš„ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿®æ”¹è¯¥çš„ã€‚ä½†æˆ‘ä»¬æœ‰æ—¶ä¸ºäº†æŸç§ç‰¹æ®Šéœ€è¦ï¼Œä¸ºäº†ä¸è®©åˆ«äººä¸€çœ¼çœ‹å‡ºæ–‡ä»¶å·²ç»ç»™ä¿®æ”¹äº†ï¼Œæˆ‘ä»¬åˆéœ€è¦ä¿®æ”¹æ–‡ä»¶çš„`åˆ›å»ºæ—¶é—´`å’Œ`ä¿®æ”¹æ—¶é—´`ã€‚é‚£ä¹ˆå¦‚ä½•ä¿®æ”¹æ–‡ä»¶å¤¹æ—¶é—´ï¼Œå¦‚ä½•ä¿®æ”¹æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ï¼Œå¦‚ä½•æ‰¹é‡ä¿®æ”¹æ–‡ä»¶çš„`åˆ›å»ºæ—¶é—´`ã€`ä¿®æ”¹æ—¶é—´`å’Œ`è®¿é—®æ—¶é—´`å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œæ¥ä¸‹æ¥å°±å¸¦ä½ è‡ªå·±ä¿®æ”¹ä»–ä»¬ã€‚æ‰€ä»¥ï¼Œé—²è¯ä¸å¤šè¯´å•¦ï¼Œå¼€å§‹å†™æˆ‘ä»¬çš„ä»£ç å•¦~~

> psï¼šå°å·¥å…·æ¨è[NewFileTime](https://wwa.lanzous.com/iNDjKdqzg9e)ï¼Œä»¥ä¸Šç®€è¿°æ‘˜æŠ„äº`NewFileTime`

# ç®€å•çš„æ­å»ºä¸€ä¸‹

- æ–°å»ºä¸€ä¸ª `files` ç›®å½•

- åˆå§‹åŒ–ä¸€ä¸ª`node`é¡¹ç›®å·¥ç¨‹

  ```bash
  npm init -y
  ```

çœ‹åˆ°è¿™é‡Œä½ ä¼šå‘ç°ï¼Œå…¶å®æˆ‘æ²¡æœ‰å®‰è£…ä¾èµ–ï¼Œæ˜¯å› ä¸ºåŸç”Ÿçš„åº“æœ‰è¿™ä¸ªè‡ªå¸¦çš„åŠŸèƒ½å—ï¼Ÿè¯´æ˜¯ä¹Ÿè¡Œï¼Œè¯´ä¸æ˜¯ä¹Ÿè¡Œã€‚åŸç”Ÿçš„`utimes`ç›®å‰æ”¯æŒä¿®æ”¹æ–‡ä»¶çš„`ä¿®æ”¹æ—¶é—´`å’Œ`è®¿é—®æ—¶é—´`ï¼Œä¸æ”¯æŒä¿®æ”¹æ–‡ä»¶çš„`åˆ›å»ºæ—¶é—´`ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“æ¥ä¿®æ”¹ã€‚

## ä¸ºä»€ä¹ˆä¸ç›´æ¥å®‰è£…è¿™ä¸ªç¬¬ä¸‰æ–¹åº“å‘¢ï¼Ÿ

å› ä¸ºè¿™ä¸ªåº“æœ‰äº›è®¸ç‰¹æ®Šï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯ä½ç‰ˆæœ¬`Node`å¯ä»¥ç›´æ¥å®‰è£…ï¼Œåœ¨æˆ‘æœ¬æœºçš„`Node13`ä¸Šè¿è¡Œåˆ™ä¼šå¤±è´¥ã€‚å…·ä½“åŸå› å˜›ï¼Œå¯ä»¥çœ‹çœ‹ä¸‹æ–¹çš„é“¾æ¥

> ps: [åŸå›  + è§£å†³æ–¹æ¡ˆ](https://github.com/ronomon/utimes/pull/8)

æ‰€ä»¥ï¼Œåœ¨ä½ç‰ˆæœ¬çš„`Node`æˆ‘ä»¬å¯ä»¥ç›´æ¥`npm install @ronomon/utimes`ï¼Œè€Œåœ¨ç‰ˆæœ¬ç›¸å¯¹è¾ƒé«˜çš„åˆ™éœ€è¦`npm i https://github.com/Jule-/utimes.git#napi-migration`å•¦

è¿™é‡Œä¹Ÿæä¸€å˜´ï¼Œå¦‚æœ`@ronomon/utimes`å®‰è£…å¤±è´¥çš„è¯ï¼Œæ˜¯å› ä¸ºè¿™äº›`åŸç”ŸNode`æ‹“å±•æ˜¯éœ€è¦ç¼–è¯‘çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½éœ€è¦å®‰è£…`windows-build-tools`ï¼Œå³ä»¥ç®¡ç†å‘˜èº«ä»½å¯åŠ¨`PowerShell`å¹¶è¿è¡Œï¼š

```bash
npm install --global windows-build-tools
```

å®‰è£…å®Œä¾èµ–ä¹‹åå°±å¯ä»¥æ­£å¼å†™æˆ‘ä»¬çš„ä»£ç å•¦ï¼Œå…¶å®è¿™ä¸ªä»£ç ç›¸å¯¹ç®€å•ï¼Œå°±æ˜¯ç›´æ¥è°ƒç”¨å®ƒçš„`api`å°±å¥½äº†ã€‚

# ç®€å•çš„ä½¿ç”¨ä¸€ä¸‹

- æ–°å»ºä¸€ä¸ª`test-files`æ–‡ä»¶å¤¹

- åœ¨`test-files`æ–‡ä»¶å¤¹æ–°å»º`1.txt`æ–‡ä»¶ä¾›æˆ‘ä»¬æµ‹è¯•

  ![1.txtæ–‡ä»¶](https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-06-17/utimes02.jpg)

- ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š

  ```js
  // å¯¼å…¥ utimes
  const { utimes } = require("@ronomon/utimes");
  utimes(
    "./test-files/1.txt",
    // åˆ›å»ºæ—¶é—´
    +new Date("2010/01/01"),
    // ä¿®æ”¹æ—¶é—´
    +new Date("2010/01/02"),
    // è®¿é—®æ—¶é—´
    +new Date("2010/01/03"),
    (err) => {
      //  ä¿®æ”¹æˆåŠŸçš„å›è°ƒ
      console.log(`success`);
    }
  );
  ```

- è¿è¡Œä»£ç ï¼Œ`node app.js`ï¼Œæ˜¯éƒ½å‘ç°æ—¥æœŸå‘ç”Ÿäº†æ”¹å˜å‘¢ï¼Ÿ

  ![1.txtæ–‡ä»¶](https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-06-17/utimes02.jpg)

çœ‹åˆ°è¿™é‡Œä½ ä»¥ä¸ºæ˜¯ä¸æ˜¯å†™å®Œäº†ï¼Œå…¶å®ä¹Ÿå·®ä¸å¤šäº† ğŸ˜ï¼Œä¸è¿‡æˆ‘å½“ç„¶ä¸ä¼šè®©ä½ æ”¶è·è¿™ä¹ˆå°‘çš„ï¼Œè‡³å°‘æˆ‘ä»¬å¯ä»¥çœ‹çœ‹æˆ‘ä»¬è¿™ä¸ªæœ€æœ€æœ€ç®€å•çš„ä¾‹å­çš„ç¼ºç‚¹ï¼Œæ¯”å¦‚ä»£ç æ²¡æœ‰`Promise`åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å°è£…ä¸€ä¸‹`utimes`

```js
/**
 *
 * @param {String} path => è·¯å¾„
 * @param {Number} btime => åˆ›å»ºæ—¶é—´ï¼Œä¸ä¼ å³ä¸ä¿®æ”¹
 * @param {Number} mtime => ä¿®æ”¹æ—¶é—´ï¼Œä¸ä¼ å³ä¸ä¿®æ”¹
 * @param {Number} atime => è®¿é—®æ—¶é—´ï¼Œä¸ä¼ å³ä¸ä¿®æ”¹
 */
const utimesPromise = (path, btime, mtime, atime) => {
  return new Promise((resolve, reject) => {
    utimes(path, btime, mtime, atime, (err) => (err ? reject(err) : resolve()));
  });
};
```

å½“ç„¶- -ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯`Node`ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å¸¸è§„çš„ç”¨`new Promise`å°è£…ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å†…ç½®çš„`util`è¿™ä¸ªå·¥å…·ä¸­çš„`promisify`æ–¹æ³•å°è£…å³å¯

> util.promisify æ˜¯åœ¨ node.js 8.x ç‰ˆæœ¬ä¸­æ–°å¢çš„ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºå°†è€å¼çš„ `Error first callback` è½¬æ¢ä¸º `Promise` å¯¹è±¡ï¼Œè®©è€é¡¹ç›®æ”¹é€ å˜å¾—æ›´ä¸ºè½»æ¾ã€‚åœ¨å®˜æ–¹æ¨å‡ºè¿™ä¸ªå·¥å…·ä¹‹å‰ï¼Œæ°‘é—´å·²ç»æœ‰å¾ˆå¤šç±»ä¼¼çš„å·¥å…·äº†ï¼Œæ¯”å¦‚ `es6-promisify`ã€`thenify`ã€`bluebird.promisify`ã€‚ä»¥åŠå¾ˆå¤šå…¶ä»–ä¼˜ç§€çš„å·¥å…·ï¼Œéƒ½æ˜¯å®ç°äº†è¿™æ ·çš„åŠŸèƒ½ï¼Œå¸®åŠ©æˆ‘ä»¬åœ¨å¤„ç†è€é¡¹ç›®çš„æ—¶å€™ï¼Œä¸å¿…è´¹ç¥å°†å„ç§ä»£ç ä½¿ç”¨ `Promise` å†é‡æ–°å®ç°ä¸€éã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬çš„å°è£…åˆå˜å¾—æ›´åŠ ç®€å•äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
const { promisify } = require("util");
const utimesPromise = promisify(utimes);
```

ä¹‹å‰çš„ä»£ç å°±å¯ä»¥æ”¹å†™æˆä¹‹å‰æˆ‘ä»¬é‚£æ ·çš„è‡ªæ‰§è¡Œ`Async Function`äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
// ...
(async () => {
  await utimesPromise(
    "./test-files/1.txt",
    // åˆ›å»ºäº‹ä»¶
    +new Date("2010/01/01"),
    // ä¿®æ”¹æ—¶é—´
    +new Date("2010/01/02"),
    // è®¿é—®æ—¶é—´
    +new Date("2010/01/03")
  );
})();
```

å†™åˆ°è¿™é‡Œï¼Œä½ ä¼šå‘ç°å…¶å®æˆ‘ä»¬æ ¹æœ¬æ²¡æœ‰åšæ‰¹é‡ä¿®æ”¹ï¼Œæ˜¯å› ä¸ºæœ‰äº†ä¹‹å‰çš„ç»éªŒï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡`glob`è¿™ä¸ªå·¥å…·è·å–æ‰€æœ‰çš„è·¯å¾„ï¼Œæ ¹æœ¬ä¸è¦æˆ‘ä»¬æ“å¿ƒï¼Œå†™èµ·æ¥ä¹Ÿååˆ†ç®€å•ï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—æœ€åå†æ¥å†™

- å®‰è£…`glob`

  ```bash
  npm i glob -S
  ```

- å¤šå»ºå‡ ä¸ªæ–‡ä»¶ç”¨äºæµ‹è¯•æˆ‘ä»¬çš„ä»£ç 

  ![åˆ›å»ºæ–‡ä»¶](https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-06-17/utimes03.jpg)

  å¾—å‡ºä¸‹é¢åˆ—è¡¨ï¼š

  ![åˆ›å»ºæ–‡ä»¶](https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-06-17/utimes04.jpg)

- ä¿®æ”¹æˆ‘ä»¬çš„ä»£ç ï¼š

  ```js
  const { utimes } = require("@ronomon/utimes");
  const glob = require("glob");
  const { promisify } = require("util");

  /**
   *
   * @param {String} path => è·¯å¾„
   * @param {Number} btime => åˆ›å»ºæ—¶é—´ï¼Œä¸ä¼ å³ä¸ä¿®æ”¹
   * @param {Number} mtime => ä¿®æ”¹æ—¶é—´ï¼Œä¸ä¼ å³ä¸ä¿®æ”¹
   * @param {Number} atime => è®¿é—®æ—¶é—´ï¼Œä¸ä¼ å³ä¸ä¿®æ”¹
   */
  const utimesPromise = promisify(utimes);

  (async () => {
    const paths = glob.sync("./test-files/**");
    const len = paths.length;
    for (let i = 0; i < len; i++) {
      await utimesPromise(
        paths[i],
        +new Date("2010/01/01"),
        +new Date("2010/01/02"),
        +new Date("2010/01/04")
      );
    }
  })();
  ```

- å¾—å‡ºç»“æœ

  ![è¿è¡Œç»“æœ](https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-06-17/utimes05.jpg)

è¿™æ ·å­å°±é€’å½’äº†æˆ‘ä»¬æ‰€æœ‰çš„æ–‡ä»¶å¤¹è·Ÿå­æ–‡ä»¶äº†è¿›è¡Œä¿®æ”¹äº†ï¼Œæœ¬æ¥æƒ³ç€åœ¨åŠ è½½åå­—ä¿®æ”¹çš„ï¼Œä½†è‹¦äº- -æ²¡æœ‰ç•Œé¢ï¼Œç¯‡å¹…ä¹Ÿè¿‡é•¿ï¼Œå°±ç•™ç€è¿‡å‡ å¤©å†å†™äº†ã€‚

> [gitee åœ°å€](https://gitee.com/gating/demo/tree/master/files),[github åœ°å€](https://github.com/GATING/demo/tree/master/files)

# æœ€å

æ„Ÿè°¢å„ä½è§‚ä¼—è€çˆ·çš„è§‚çœ‹ O(âˆ©_âˆ©)O å¸Œæœ›ä½ èƒ½æœ‰æ‰€æ”¶è· ğŸ˜
