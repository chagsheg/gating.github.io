<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><title>node实现文件属性批量修改(文件名) | 磨蹭先生</title><meta name="description" content="书接上回，我们实现了批量修改文件的时间，但是却没有实现文件名称的批量修改，是因为我也说过，没有界面的话直接在命令行实现显得有点繁琐，所以我们就通过`接口+界面`的方式来实现我们这个小需求吧。所以，闲话不多说啦，开始写我们的代码啦~~"><meta name="keywords" content="vue,node"><meta name="author" content="gating"><meta name="copyright" content="gating"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/GATING/blog_imgs@master/blog/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://hm.baidu.com"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="node实现文件属性批量修改(文件名)"><meta name="twitter:description" content="书接上回，我们实现了批量修改文件的时间，但是却没有实现文件名称的批量修改，是因为我也说过，没有界面的话直接在命令行实现显得有点繁琐，所以我们就通过`接口+界面`的方式来实现我们这个小需求吧。所以，闲话不多说啦，开始写我们的代码啦~~"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="node实现文件属性批量修改(文件名)"><meta property="og:url" content="https://gatings.cn/2020-07-05/node%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9(%E6%96%87%E4%BB%B6%E5%90%8D)/"><meta property="og:site_name" content="磨蹭先生"><meta property="og:description" content="书接上回，我们实现了批量修改文件的时间，但是却没有实现文件名称的批量修改，是因为我也说过，没有界面的话直接在命令行实现显得有点繁琐，所以我们就通过`接口+界面`的方式来实现我们这个小需求吧。所以，闲话不多说啦，开始写我们的代码啦~~"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode="1";var t=Cookies.get("theme");{const e=window.matchMedia("(prefers-color-scheme: dark)").matches,o=window.matchMedia("(prefers-color-scheme: light)").matches,a=window.matchMedia("(prefers-color-scheme: no-preference)").matches,c=!e&&!o&&!a;void 0===t?o?activateLightMode():e?activateDarkMode():(a||c)&&(console.log("You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time."),now=new Date,hour=now.getHours(),isNight=hour<6||hour>=18,isNight?activateDarkMode():activateLightMode()):"light"==t?activateLightMode():activateDarkMode()}function activateDarkMode(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#000")}function activateLightMode(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#fff")}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://gatings.cn/2020-07-05/node%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9(%E6%96%87%E4%BB%B6%E5%90%8D)/"><link rel="prev" title="JS中有趣的内置对象-JSON" href="https://gatings.cn/2020-09-08/JS%E4%B8%AD%E6%9C%89%E8%B6%A3%E7%9A%84%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1-JSON/"><link rel="next" title="node实现文件属性批量修改(时间属性)" href="https://gatings.cn/2020-06-17/node%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9/"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?914d8fcbdf614fcc92017b47706d7bee";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容:${query}"}},translate:{defaultEncoding:2,translateDelay:0,cookieDomain:"https://gatings.cn/",msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简"},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},bookmark:{title:"Snackbar.bookmark.title",message_prev:"按",message_next:"键将本页加入书签"},runtime_unit:"天",runtime:!0,copyright:void 0,ClickShowText:void 0,medium_zoom:!0,fancybox:!0,Snackbar:{bookmark:{title:"Snackbar.bookmark.title",message_prev:"按",message_next:"键将本页加入书签"},chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#2d3035",position:"bottom-left"},baiduPush:!0,isHome:!1,isPost:!0}</script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="磨蹭先生" type="application/atom+xml">
</head><body><header><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">磨蹭先生</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/GATING/blog_imgs@master/blog/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">38</div></a></div></div><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">18</div></a></div></div><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#前言"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#简单的说下实现的效果"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">简单的说下实现的效果</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#简单的搭建一下"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">简单的搭建一下</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Koa-是什么"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">Koa 是什么</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#上下文（Context）"><span class="toc_mobile_items-number">3.1.1.</span> <span class="toc_mobile_items-text">上下文（Context）</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#ctx-req-和-ctx-request-的区别"><span class="toc_mobile_items-number">3.1.1.1.</span> <span class="toc_mobile_items-text">ctx.req 和 ctx.request 的区别</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#ctx-body-和-ctx-request-body-傻傻分不清"><span class="toc_mobile_items-number">3.1.1.2.</span> <span class="toc_mobile_items-text">ctx.body 和 ctx.request.body 傻傻分不清</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Koa-中间件"><span class="toc_mobile_items-number">3.1.2.</span> <span class="toc_mobile_items-text">Koa 中间件</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#简单的搭建前端项目"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">简单的搭建前端项目</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#编写布局"><span class="toc_mobile_items-number">4.1.</span> <span class="toc_mobile_items-text">编写布局</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#拆分页面"><span class="toc_mobile_items-number">4.1.1.</span> <span class="toc_mobile_items-text">拆分页面</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#思考一下"><span class="toc_mobile_items-number">4.1.2.</span> <span class="toc_mobile_items-text">思考一下</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#Antd-的坑"><span class="toc_mobile_items-number">4.1.2.1.</span> <span class="toc_mobile_items-text">Antd 的坑</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#post-请求下载文件"><span class="toc_mobile_items-number">4.1.2.2.</span> <span class="toc_mobile_items-text">post 请求下载文件</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#书写前端逻辑"><span class="toc_mobile_items-number">4.2.</span> <span class="toc_mobile_items-text">书写前端逻辑</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#思考一下-1"><span class="toc_mobile_items-number">4.2.1.</span> <span class="toc_mobile_items-text">思考一下</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#处理文件名和后缀名"><span class="toc_mobile_items-number">4.2.2.</span> <span class="toc_mobile_items-text">处理文件名和后缀名</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#优化相关"><span class="toc_mobile_items-number">4.3.</span> <span class="toc_mobile_items-text">优化相关</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#预加载-preload-和预处理-prefetch"><span class="toc_mobile_items-number">4.3.1.</span> <span class="toc_mobile_items-text">预加载(preload)和预处理(prefetch)</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#提取-runtime-js"><span class="toc_mobile_items-number">4.3.2.</span> <span class="toc_mobile_items-text">提取 runtime.js</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#对第三方库进行拆包"><span class="toc_mobile_items-number">4.3.3.</span> <span class="toc_mobile_items-text">对第三方库进行拆包</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#其他优化"><span class="toc_mobile_items-number">4.3.4.</span> <span class="toc_mobile_items-text">其他优化</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#编写后端"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">编写后端</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#路由的使用"><span class="toc_mobile_items-number">5.1.</span> <span class="toc_mobile_items-text">路由的使用</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#文件上传"><span class="toc_mobile_items-number">5.2.</span> <span class="toc_mobile_items-text">文件上传</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#为啥使用-koa-body-而不是-koa-bodyparser？"><span class="toc_mobile_items-number">5.2.1.</span> <span class="toc_mobile_items-text">为啥使用 koa-body 而不是 koa-bodyparser？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#文件上传优化"><span class="toc_mobile_items-number">5.2.2.</span> <span class="toc_mobile_items-text">文件上传优化</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#文件下载"><span class="toc_mobile_items-number">5.3.</span> <span class="toc_mobile_items-text">文件下载</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#最后"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">最后</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#简单的说下实现的效果"><span class="toc-number">2.</span> <span class="toc-text">简单的说下实现的效果</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#简单的搭建一下"><span class="toc-number">3.</span> <span class="toc-text">简单的搭建一下</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Koa-是什么"><span class="toc-number">3.1.</span> <span class="toc-text">Koa 是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#上下文（Context）"><span class="toc-number">3.1.1.</span> <span class="toc-text">上下文（Context）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ctx-req-和-ctx-request-的区别"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">ctx.req 和 ctx.request 的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ctx-body-和-ctx-request-body-傻傻分不清"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">ctx.body 和 ctx.request.body 傻傻分不清</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Koa-中间件"><span class="toc-number">3.1.2.</span> <span class="toc-text">Koa 中间件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#简单的搭建前端项目"><span class="toc-number">4.</span> <span class="toc-text">简单的搭建前端项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#编写布局"><span class="toc-number">4.1.</span> <span class="toc-text">编写布局</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#拆分页面"><span class="toc-number">4.1.1.</span> <span class="toc-text">拆分页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#思考一下"><span class="toc-number">4.1.2.</span> <span class="toc-text">思考一下</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Antd-的坑"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">Antd 的坑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#post-请求下载文件"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">post 请求下载文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#书写前端逻辑"><span class="toc-number">4.2.</span> <span class="toc-text">书写前端逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#思考一下-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">思考一下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#处理文件名和后缀名"><span class="toc-number">4.2.2.</span> <span class="toc-text">处理文件名和后缀名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#优化相关"><span class="toc-number">4.3.</span> <span class="toc-text">优化相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#预加载-preload-和预处理-prefetch"><span class="toc-number">4.3.1.</span> <span class="toc-text">预加载(preload)和预处理(prefetch)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#提取-runtime-js"><span class="toc-number">4.3.2.</span> <span class="toc-text">提取 runtime.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对第三方库进行拆包"><span class="toc-number">4.3.3.</span> <span class="toc-text">对第三方库进行拆包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他优化"><span class="toc-number">4.3.4.</span> <span class="toc-text">其他优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#编写后端"><span class="toc-number">5.</span> <span class="toc-text">编写后端</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#路由的使用"><span class="toc-number">5.1.</span> <span class="toc-text">路由的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件上传"><span class="toc-number">5.2.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#为啥使用-koa-body-而不是-koa-bodyparser？"><span class="toc-number">5.2.1.</span> <span class="toc-text">为啥使用 koa-body 而不是 koa-bodyparser？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件上传优化"><span class="toc-number">5.2.2.</span> <span class="toc-text">文件上传优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件下载"><span class="toc-number">5.3.</span> <span class="toc-text">文件下载</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#最后"><span class="toc-number">6.</span> <span class="toc-text">最后</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image:url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">node实现文件属性批量修改(文件名)</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-07-05<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-11-03</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%B0%8F%E5%B7%A5%E5%85%B7/">小工具</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">14.3k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 56 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>书接上回，我们实现了<code>批量修改文件的时间</code>，但是却没有实现<code>文件名称的批量修改</code>，是因为我也说过，没有界面的话直接在命令行实现显得有点繁琐，所以我们就通过<code>接口+界面</code>的方式来实现我们这个小需求吧。所以，闲话不多说啦，开始写我们的代码啦~~</p><p>本次教程过于啰嗦，所以这里先放上预览地址供大家预览——<a href="https://gating.gitee.io/demo/batch-modify-filenames/" target="_blank" rel="noopener">点我预览</a>，也可到文末直接下载代码先自行体验。。。</p><h1 id="简单的说下实现的效果"><a href="#简单的说下实现的效果" class="headerlink" title="简单的说下实现的效果"></a>简单的说下实现的效果</h1><p>通常我们在<code>蓝湖</code>上下载的切图是和<code>UI小姐姐</code>定义的图层名相关的，一般下载下来之后我们就需要修改名称，但是一个个修改又显得十分傻逼 😆，所以我们就自己写一下代码自己修改，具体效果如图：</p><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/need.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="产品效果" class="fancybox"><img alt="产品效果" title="产品效果" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/need.png" class="lazyload"></a></p><p>看到这里，是不是也想跃跃欲试啦，所以，我们就开始写我们的代码吧</p><h1 id="简单的搭建一下"><a href="#简单的搭建一下" class="headerlink" title="简单的搭建一下"></a>简单的搭建一下</h1><ul><li><p>新建一个 <code>batch-modify-filenames</code> 目录</p></li><li><p>初始化一个<code>node</code>项目工程</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm init -y</span><br></pre></td></tr></table></figure></div></li><li><p>安装依赖，这里依赖比较多，所以下面我会讲一下他们大概是干嘛的</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm i archiver glob koa koa-body koa-router koa-static uuid -S</span><br><span class="line">npm i nodemon -D</span><br></pre></td></tr></table></figure></div><ul><li>koa <code>Nodejs的Web框架</code></li><li>koa-body <code>解析 post 请求，支持文件上传</code></li><li>koa-router <code>处理路由(接口)相关</code></li><li>koa-static <code>处理静态文件</code></li><li>glob <code>批量处理文件</code></li><li>uuid <code>生成不重复的文件名</code></li><li>nodemon <code>监听文件变化，自动重启项目</code></li><li>archiver <code>压缩成 zip 文件</code></li></ul><blockquote><p>ps：nodemon 是用于我们调试的，所以他是开发依赖，所以我们需要<code>-D</code>。其他的都是主要依赖，所以<code>-S</code></p></blockquote></li><li><p>配置一下我们的启动命令</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">      <span class="string">"dev"</span>: <span class="string">"nodemon app.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li></ul><h2 id="Koa-是什么"><a href="#Koa-是什么" class="headerlink" title="Koa 是什么"></a>Koa 是什么</h2><p>既然用到了<code>Koa</code>，那么我们就了解一下他是什么？</p><p><code>Koa</code> 是由 <code>Express</code> 原班人马打造的，致力于成为一个更小、更富有表现力、更健壮的 Web 框架，采用了 <code>async</code> 和 <code>await</code> 的方式执行异步操作。 <code>Koa</code> 并没有捆绑任何中间件， 而是提供了一套优雅的方法，帮助您快速而愉快地编写服务端应用程序。也正是因为没有捆绑任何中间件，<code>Koa</code> 保持着一个很小的体积。</p><p>通俗点来讲，就是常说的后端框架，处理我们前端发送过去的请求。</p><h3 id="上下文（Context）"><a href="#上下文（Context）" class="headerlink" title="上下文（Context）"></a>上下文（Context）</h3><p><code>Koa Context</code> 将 <code>node</code> 的 <code>request</code> 和 <code>response</code> 对象封装到单个对象中，为编写 Web 应用程序和 API 提供了许多有用的方法。 这些操作在 <code>HTTP</code> 服务器开发中频繁使用，它们被添加到此级别而不是更高级别的框架，这将强制中间件重新实现此通用功能。</p><p><code>Context</code>这里我们主要用到了<code>state</code>、<code>request</code>、<code>response</code>这几个常用的对象，这里我大概讲讲他们的作用。</p><ul><li>state <code>推荐的命名空间，用于通过中间件传递信息和你的前端视图。</code></li><li>req <code>Node 的 Request 对象.</code></li><li>request <code>Koa 的 Request 对象.</code></li><li>res <code>Node 的 Response 对象.</code></li><li>response <code>Koa 的 Response 对象.</code></li></ul><h4 id="ctx-req-和-ctx-request-的区别"><a href="#ctx-req-和-ctx-request-的区别" class="headerlink" title="ctx.req 和 ctx.request 的区别"></a>ctx.req 和 ctx.request 的区别</h4><p>通常刚学<code>Koa</code>的时候，估计有不少人弄混这两个的区别，这里就说说他们两有什么区别吧。</p><p>最主要的区别是，<code>ctx.request</code> 是 <code>context</code> 经过封装的请求对象，<code>ctx.req</code> 是 <code>context</code> 提供的 <code>node.js</code> 原生 <code>HTTP</code> 请求对象，同理 <code>ctx.response</code> 是 <code>context</code> 经过封装的响应对象，<code>ctx.res</code> 是 <code>context</code> 提供的 <code>node.js</code> 原生 <code>HTTP</code> 响应对象。</p><p>所以，通常我们是通过<code>ctx.request</code>获取请求参数，通过<code>ctx.response</code>设置返回值，不要弄混了哦 (⊙o⊙)</p><h4 id="ctx-body-和-ctx-request-body-傻傻分不清"><a href="#ctx-body-和-ctx-request-body-傻傻分不清" class="headerlink" title="ctx.body 和 ctx.request.body 傻傻分不清"></a>ctx.body 和 ctx.request.body 傻傻分不清</h4><p>以为通常<code>get</code>请求我们可以直接通过<code>ctx.query(ctx.request.query的别名)</code>就可以获得提交过来的数据，<code>post</code>请求的话这是通过<code>body</code>来获取，所以通常我们会通过猜想，以为<code>ctx.body</code>也是<code>ctx.request.body</code>的别名，其实- -这个是不对的。因为我们不仅要接受数据，最重要还要响应数据给前端，所以<code>ctx.body</code>是<code>ctx.response.body</code>的别名。而<code>ctx.request.body</code>为了区分，是没有设置别名的，即只能通过<code>ctx.request.body</code>获取<code>post</code>提交过来的数据。</p><blockquote><p>总结：<code>ctx.body</code>是<code>ctx.response.body</code>的别名，而<code>ctx.request.body</code>是<code>post</code>提交过来的数据</p></blockquote><h3 id="Koa-中间件"><a href="#Koa-中间件" class="headerlink" title="Koa 中间件"></a>Koa 中间件</h3><p><code>Koa</code> 的最大特色，也是最重要的一个设计，就是<code>中间件（middleware）</code>。<code>Koa</code> 应用程序是一个包含一组中间件函数的对象，它是按照类似堆栈的方式组织和执行的。<code>Koa</code> 中使用 <code>app.use()</code>用来加载中间件，基本上 <code>Koa</code> 所有的功能都是通过中间件实现的。每个中间件默认接受两个参数，第一个参数是 <code>Context</code> 对象，第二个参数是 <code>next</code> 函数。只要调用 <code>next</code> 函数，就可以把执行权转交给下一个中间件。</p><p>下面两张图很清晰的表明了一个请求是如何经过中间件最后生成响应的，这种模式中开发和使用中间件都是非常方便的：</p><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/onion-model01.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="洋葱模型1" class="fancybox"><img alt="洋葱模型1" title="洋葱模型1" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/onion-model01.png" class="lazyload"></a></p><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/onion-model02.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="洋葱模型2" class="fancybox"><img alt="洋葱模型2" title="洋葱模型2" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/onion-model02.png" class="lazyload"></a></p><p>再来看下 <code>Koa</code> 的洋葱模型实例代码：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">await</span> next();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">6</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">await</span> next();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">5</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">  <span class="keyword">await</span> next();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.listen(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure></div><p>怎么样，是不是有一点点感觉了。当程序运行到 <code>await next()</code>的时候就会暂停当前程序，进入下一个中间件，处理完之后才会回过头来继续处理。</p><p>理解完这些后就可以开始写我们的代码啦！！！ (lll ￢ ω ￢)，好像写了好多和这次教程主题没关的东西，见怪莫怪啦</p><h1 id="简单的搭建前端项目"><a href="#简单的搭建前端项目" class="headerlink" title="简单的搭建前端项目"></a>简单的搭建前端项目</h1><p>既然说到了写界面，这里我们技术栈就采用<code>vue</code>吧，然后<code>UI</code>库的话，大家都用惯了<code>ElementUI</code>，我想大家都特别熟悉了，所以我们这里就采用<code>Ant Design Vue</code>吧，也方便大家对<code>Antd</code>熟悉一下，也没什么坏处</p><p>所以，我们就简单的创建一下我们的项目，在我们<code>batch-modify-filenames</code>文件夹下运行<code>vue create batch-front-end</code>，如图所示:</p><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames01.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="简单的编写界面" class="fancybox"><img alt="简单的编写界面" title="简单的编写界面" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames01.png" class="lazyload"></a></p><p>基本上都是无脑下一步，只不过是<code>ant-design-vue</code>用了<code>less</code>，我们为了符合它的写法，我们配置上也采用<code>less</code>。当然，采用<code>sass</code>也是可以的，没什么强制要求。</p><p>创建完项目后就是安装依赖了，因为其实我们用到的组件不多，所以这里我们使用按需加载，即需要安装<code>babel-plugin-import</code>，这里<code>babel-plugin-import</code>也是开发依赖，生产环境是不需要的，所以安装的时候需要<code>-D</code></p><p>这里我们用到了一个常用的<code>工具库（类库）—— lodash</code>，我们不一定用到他所有的方法，所以我们也需要安装个<code>babel</code>插件进行按需加载，即<code>babel-plugin-transform-imports</code>，同样也是<code>-D</code></p><p>最后，既然是与后端做交互，我们肯定需要用到一个<code>http</code>库啦，既然官方推荐我们用<code>axios</code>，所以这里我们也要把<code>axios</code>装上，不过<code>axios</code>不是<code>vue</code>的插件,所以不能直接用<code>use</code>方法。所以，这里我为了方便，也把<code>vue-axios</code>装上了。在之后，因为我又不想把最终的<code>zip</code>文件留在服务器上，毕竟会占用空间，所以我以<strong>流(Stream)</strong>的方式返回给前端，让前端自己下载，那么这里我就采用一个成熟第三方库实现，也就是<code>file-saver</code>，所以最终我们的依赖项就是：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install ant-design-vue lodash axios vue-axios file-saver -S</span><br><span class="line">npm install babel-plugin-import babel-plugin-transform-imports -D</span><br></pre></td></tr></table></figure></div><p>配置<code>babel.config.js</code>:</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  presets: [<span class="string">"@vue/cli-plugin-babel/preset"</span>],</span><br><span class="line">  plugins: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">"import"</span>,</span><br><span class="line">      &#123; <span class="attr">libraryName</span>: <span class="string">"ant-design-vue"</span>, <span class="attr">libraryDirectory</span>: <span class="string">"es"</span>, <span class="attr">style</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    ], <span class="comment">// `style: true` 会加载 less 文件,</span></span><br><span class="line">    [</span><br><span class="line">      <span class="string">"transform-imports"</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        lodash: &#123;</span><br><span class="line">          transform: <span class="string">"lodash/$&#123;member&#125;"</span>,</span><br><span class="line">          preventFullImport: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><p>因为我们这里改成了<code>style: true</code>，按需引入的时候大概会报下面的这个错误：</p><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames02.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="按需加载报错" class="fancybox"><img alt="按需加载报错" title="按需加载报错" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames02.png" class="lazyload"></a></p><p>解决方案这里也说的很清楚了，在<a href="https://github.com/ant-design/ant-motion/issues/44" target="_blank" rel="noopener">https://github.com/ant-design/ant-motion/issues/44</a>这个链接，也有说明<code>Inline JavaScript is not enabled. Is it set in your options?</code>，告诉我们<code>less</code>没开启<code>JavaScript</code>功能，我们需要修改下 l<code>less-loader</code>的配置即可</p><p>因为<code>vue-cli4</code>的<code>webpack</code>不像<code>vue-cli2.x</code>，他对外屏蔽了<code>webpack</code>的细节，如果想修改必须创建<code>vue.config.js</code>来修改配置，所以我们创建一个<code>vue.config.js</code>文件，书写下面配置：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  css: &#123;</span><br><span class="line">    loaderOptions: &#123;</span><br><span class="line">      less: &#123;</span><br><span class="line">        javascriptEnabled: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><p>关掉服务，再重新跑一下<code>npm run serve</code>，看是不是没有报错了？这样子我就可以书写我们的代码了。</p><h2 id="编写布局"><a href="#编写布局" class="headerlink" title="编写布局"></a>编写布局</h2><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames03.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="批处理界面" class="fancybox"><img alt="批处理界面" title="批处理界面" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames03.png" class="lazyload"></a></p><p>界面大概长这样子，我想大家写界面应该比我厉害多了，都是直接套用<code>Antd</code>的组件，所以这里我主要分析我们怎么拆分这个页面的组件比较好，怎么定义我们的数据比较好~~</p><p>从这个图我们可以看出<strong>新文件列表</strong>是基于<strong>原文件列表+各种设置</strong>得出来的，所以<strong>新文件列表</strong>我们就可以采用<code>计算属性(computed)</code>来实现啦，那么接下来就是拆分我们页面的时候啦。。。</p><blockquote><p>ps：这里我不会详细讲怎么写界面，只会把我觉得对开发有用的讲出来，不然文章就太多冗长了。虽然现在也十分冗长了（；´д ｀）ゞ</p></blockquote><h3 id="拆分页面"><a href="#拆分页面" class="headerlink" title="拆分页面"></a>拆分页面</h3><p>其实从页面的分割线我们大概就可以看出，他是分成 3 个大的子组件了，还有<strong>文件列表</strong>可以单独划分为孙子组件，所以基本上如图所示：</p><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames04.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="拆分页面" class="fancybox"><img alt="拆分页面" title="拆分页面" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames04.png" class="lazyload"></a></p><p>代码结构如图：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">|-- batch-front-end</span><br><span class="line">    ├─.browserslistrc</span><br><span class="line">    ├─.eslintrc.js</span><br><span class="line">    ├─.gitignore</span><br><span class="line">    ├─babel.config.js</span><br><span class="line">    ├─package-lock.json</span><br><span class="line">    ├─package.json</span><br><span class="line">    ├─README.md</span><br><span class="line">    ├─vue.config.js</span><br><span class="line">    ├─src</span><br><span class="line">    |  ├─App.vue</span><br><span class="line">    |  ├─main.js</span><br><span class="line">    |  ├─utils</span><br><span class="line">    |  |   ├─helpers.js</span><br><span class="line">    |  |   ├─index.js</span><br><span class="line">    |  |   └regexp.js</span><br><span class="line">    |  ├─components</span><br><span class="line">    |  |     ├─ModifyFilename2.vue</span><br><span class="line">    |  |     ├─ModifyFilename</span><br><span class="line">    |  |     |       ├─FileList.vue</span><br><span class="line">    |  |     |       ├─FileListItem.vue</span><br><span class="line">    |  |     |       ├─FileOutput.vue</span><br><span class="line">    |  |     |       ├─FileSetting.vue</span><br><span class="line">    |  |     |       └index.vue</span><br><span class="line">    |  ├─assets</span><br><span class="line">    |  |   └logo.png</span><br><span class="line">    ├─public</span><br><span class="line">    |   ├─favicon.ico</span><br><span class="line">    |   └index.html</span><br></pre></td></tr></table></figure></div><p>看到这里，基本知道我是怎么拆分的吧？没错，一共用了四个组件分别是<code>FileSetting(文件名设置)</code>、<code>FileOutput(输出设置)</code>、<code>FileList(输出结果)</code>和<code>FileListItem(列表组件)</code>这么四大块</p><p>当然知道怎么拆分了还远远不够的，虽然现在我们只有 4 个组件，所以写起来问题不是那么的大，但是呢。。。写起页面来其实也是比较麻烦的，一般正常的写法是：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">divider</span> <span class="attr">orientation</span>=<span class="string">"left"</span>&gt;</span>文件名设置<span class="tag">&lt;/<span class="name">divider</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">FileSetting</span> <span class="attr">:fileSettings</span>=<span class="string">"fileSettings"</span> <span class="attr">:diyForm</span>=<span class="string">"diyForm"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">divider</span> <span class="attr">orientation</span>=<span class="string">"left"</span>&gt;</span>输出设置<span class="tag">&lt;/<span class="name">divider</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">FileOutput</span> <span class="attr">:ext</span>=<span class="string">"ext"</span> <span class="attr">:enable</span>=<span class="string">"enable"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">divider</span> <span class="attr">orientation</span>=<span class="string">"left"</span>&gt;</span>输出结果<span class="tag">&lt;/<span class="name">divider</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">FileList</span> <span class="attr">:oldFiles</span>=<span class="string">"oldFiles"</span> <span class="attr">:newFiles</span>=<span class="string">"newFiles"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> &#123; Divider &#125; <span class="keyword">from</span> <span class="string">"ant-design-vue"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> FileList <span class="keyword">from</span> <span class="string">"./FileList"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> FileOutput <span class="keyword">from</span> <span class="string">"./FileOutput"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> FileSetting <span class="keyword">from</span> <span class="string">"./FileSetting"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">    name: <span class="string">"ModifyFilename"</span>,</span></span><br><span class="line">    components: &#123;</span><br><span class="line">      Divider,</span><br><span class="line">      FileList,</span><br><span class="line">      FileOutput,</span><br><span class="line">      FileSetting,</span><br><span class="line">    &#125;,</span><br><span class="line">    computed: &#123;</span><br><span class="line"><span class="actionscript">      <span class="comment">// 新文件列表</span></span></span><br><span class="line">      newFiles() &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="keyword">this</span>.oldFiles;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    data() &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 存放这文件名设置的数据</span></span></span><br><span class="line">        fileSettings: &#123;&#125;,</span><br><span class="line"><span class="actionscript">        <span class="comment">// 存放自定义序号数组</span></span></span><br><span class="line">        diyForm: &#123;&#125;,</span><br><span class="line"><span class="actionscript">        <span class="comment">// 启用输出设置</span></span></span><br><span class="line"><span class="actionscript">        enable: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 输出设置后缀名</span></span></span><br><span class="line">        ext: [],</span><br><span class="line"><span class="actionscript">        <span class="comment">// 原文件列表</span></span></span><br><span class="line">        oldFiles: [],</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">"less"</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.content</span> &#123;</span></span><br><span class="line">    width: 1366px;</span><br><span class="line">    box-sizing: border-box;</span><br><span class="line">    padding: 0 15px;</span><br><span class="line">    margin: 0 auto;</span><br><span class="line">    overflow-x: hidden;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></div><h3 id="思考一下"><a href="#思考一下" class="headerlink" title="思考一下"></a>思考一下</h3><p>但是有没有发现，我们写了三个<code>divider</code>组件，要绑定的数据也是相当之多，虽然我都整合在<code>fileSettings</code>了。如果我们要单独拿出来的话，岂不是要累死个人？所以我们思考一下，怎么可以更加方便的书写我们的这个页面。所以我引申出了下面三个问题：</p><ol><li><p>有没有办法可以用一个组件来标识我们导入的另外三个子组件呢？</p></li><li><p>有没有办法一次性绑定我们要的数据，而不是一个个的绑定呢？</p></li><li><p>一次性绑定之后，组件间怎么通信呢（因为这里涵盖了子孙组件）？</p></li></ol><p>针对于这三个问题，我分别使用了<code>动态组件</code>、<code>v-bind</code>和<code>provide</code>实现的，接下来我们就讲讲怎么实现它，先上代码：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"item in components"</span> <span class="attr">:key</span>=<span class="string">"item.name"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">divider</span> <span class="attr">orientation</span>=<span class="string">"left"</span>&gt;</span>&#123;&#123; item.label &#125;&#125;<span class="tag">&lt;/<span class="name">divider</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">component</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:is</span>=<span class="string">"item.name"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">v-bind</span>=<span class="string">"&#123; ...getProps(item.props) &#125;"</span></span></span><br><span class="line"><span class="tag">        @<span class="attr">update</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">          (key, val) =&gt; &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">            update(item.props, key, val);</span></span></span><br><span class="line"><span class="tag"><span class="string">          &#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">        "</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> getNewFileList <span class="keyword">from</span> <span class="string">"@/utils/"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> &#123; Divider &#125; <span class="keyword">from</span> <span class="string">"ant-design-vue"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> FileList <span class="keyword">from</span> <span class="string">"./FileList"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> FileOutput <span class="keyword">from</span> <span class="string">"./FileOutput"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> FileSetting <span class="keyword">from</span> <span class="string">"./FileSetting"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">    name: <span class="string">"ModifyFilename"</span>,</span></span><br><span class="line">    components: &#123;</span><br><span class="line">      Divider,</span><br><span class="line">      FileList,</span><br><span class="line">      FileOutput,</span><br><span class="line">      FileSetting,</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="actionscript">    <span class="comment">// 传递给深层级子组件</span></span></span><br><span class="line">    provide() &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">        parent: <span class="keyword">this</span>,</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    data() &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line">        components: [</span><br><span class="line">          &#123;</span><br><span class="line"><span class="actionscript">            label: <span class="string">"文件名设置"</span>,</span></span><br><span class="line"><span class="actionscript">            name: <span class="string">"FileSetting"</span>,</span></span><br><span class="line"><span class="actionscript">            props: <span class="string">"fileSettingsProps"</span>,</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line"><span class="actionscript">            label: <span class="string">"输出设置"</span>,</span></span><br><span class="line"><span class="actionscript">            name: <span class="string">"FileOutput"</span>,</span></span><br><span class="line"><span class="actionscript">            props: <span class="string">"fileOutputProps"</span>,</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line"><span class="actionscript">            label: <span class="string">"输出结果"</span>,</span></span><br><span class="line"><span class="actionscript">            name: <span class="string">"FileList"</span>,</span></span><br><span class="line"><span class="actionscript">            props: <span class="string">"fileListProps"</span>,</span></span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">        fileSettingsProps: &#123;</span><br><span class="line">          fileSettings: &#123;</span><br><span class="line">            filename: &#123;</span><br><span class="line"><span class="actionscript">              value: <span class="string">""</span>,</span></span><br><span class="line">              span: 6,</span><br><span class="line"><span class="actionscript">              type: <span class="string">"file"</span>,</span></span><br><span class="line"><span class="actionscript">              placeholder: <span class="string">"请输入新的文件名"</span>,</span></span><br><span class="line">            &#125;,</span><br><span class="line">            serialNum: &#123;</span><br><span class="line"><span class="actionscript">              value: <span class="string">""</span>,</span></span><br><span class="line">              span: 6,</span><br><span class="line"><span class="actionscript">              type: <span class="string">"sort-descending"</span>,</span></span><br><span class="line"><span class="actionscript">              placeholder: <span class="string">"起始序号(默认支持纯数字或纯字母)"</span>,</span></span><br><span class="line">            &#125;,</span><br><span class="line">            increment: &#123;</span><br><span class="line">              value: 1,</span><br><span class="line">              span: 2,</span><br><span class="line"><span class="actionscript">              placeholder: <span class="string">"增量"</span>,</span></span><br><span class="line"><span class="actionscript">              isNum: <span class="literal">true</span>,</span></span><br><span class="line">            &#125;,</span><br><span class="line">            preReplaceWord: &#123;</span><br><span class="line"><span class="actionscript">              value: <span class="string">""</span>,</span></span><br><span class="line">              span: 3,</span><br><span class="line"><span class="actionscript">              type: <span class="string">"file"</span>,</span></span><br><span class="line"><span class="actionscript">              placeholder: <span class="string">"替换前的字符"</span>,</span></span><br><span class="line">            &#125;,</span><br><span class="line">            replaceWord: &#123;</span><br><span class="line"><span class="actionscript">              value: <span class="string">""</span>,</span></span><br><span class="line">              span: 3,</span><br><span class="line"><span class="actionscript">              type: <span class="string">"file"</span>,</span></span><br><span class="line"><span class="actionscript">              placeholder: <span class="string">"替换后的字符"</span>,</span></span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">          diyForm: &#123;</span><br><span class="line"><span class="actionscript">            diySerial: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">            separator: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">            diyEnable: <span class="literal">false</span>,</span></span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        fileOutputProps: &#123;</span><br><span class="line"><span class="actionscript">          enable: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">          ext: [<span class="string">""</span>, <span class="string">""</span>],</span></span><br><span class="line">        &#125;,</span><br><span class="line">        oldFiles: [],</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    computed: &#123;</span><br><span class="line">      newFiles() &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> &#123; fileSettings, diyForm &#125; = <span class="keyword">this</span>.fileSettingsProps;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> &#123; ext, enable &#125; = <span class="keyword">this</span>.fileOutputProps;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> &#123; diySerial, separator, diyEnable &#125; = diyForm;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> getNewFileList(</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">this</span>.oldFiles,</span></span><br><span class="line">          fileSettings,</span><br><span class="line">          ext,</span><br><span class="line">          enable,</span><br><span class="line"><span class="actionscript">          <span class="keyword">this</span>.getRange(diySerial, separator, diyEnable)</span></span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    watch: &#123;</span><br><span class="line"><span class="actionscript">      <span class="string">"fileSettingsProps.diyForm.diySerial"</span>(val) &#123;</span></span><br><span class="line">        if (!val) &#123;</span><br><span class="line"><span class="actionscript">          <span class="keyword">this</span>.fileSettingsProps.diyForm.diyEnable = !<span class="number">1</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">      getRange(diySerial, separator, enable) &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (!enable) <span class="keyword">return</span> <span class="literal">null</span>;</span></span><br><span class="line"><span class="actionscript">        !separator ? (separator = <span class="string">","</span>) : <span class="literal">null</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> diySerial.split(separator);</span></span><br><span class="line">      &#125;,</span><br><span class="line">      getProps(key) &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (key === <span class="string">"fileListProps"</span>) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">            oldFiles: <span class="keyword">this</span>.oldFiles,</span></span><br><span class="line"><span class="actionscript">            newFiles: <span class="keyword">this</span>.newFiles,</span></span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="keyword">this</span>[key] || &#123;&#125;;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      update(props, key, val) &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (props === <span class="string">"fileListProps"</span>) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span> (<span class="keyword">this</span>[key] = val);</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>[props][key] = val;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">"less"</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.content</span> &#123;</span></span><br><span class="line">    width: 1366px;</span><br><span class="line">    box-sizing: border-box;</span><br><span class="line">    padding: 0 15px;</span><br><span class="line">    margin: 0 auto;</span><br><span class="line">    overflow-x: hidden;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>代码里，我通过<code>component</code>的<code>is</code>来标识我们导入的组件，这样就解决了我们的第一个问题。第二个问题，从<a href="https://cn.vuejs.org/v2/api/#v-bind" target="_blank" rel="noopener">文档</a>可知，<code>v-bind</code>是可以绑定多个属性值，所以我们直接通过<code>v-bind</code>就可以实现了。<br>】<br>但是，解决第二个问题后，就引发了第三个问题，因为通常我们可以通过<code>.sync</code>修饰符来进行<code>props</code>的双向绑定，但是<a href="https://cn.vuejs.org/v2/guide/components-custom-events.html#sync-%E4%BF%AE%E9%A5%B0%E7%AC%A6" target="_blank" rel="noopener">文档</a>有说，在解析一个复杂表达式时是无法正常工作的，所以我们无法通过<code>this.$emit(&#39;update:props&#39;,newVal)</code>更新我们的值。</p><p>所以这里我自定义了一个<code>update</code>方法，通过<code>props</code>的方式传递给子组件，通过子组件触发父组件的方法实现状态的更新。当然，也通过<code>provide</code>把自身传递下去共子组件使用，这里提供<code>FileListItem(列表组件)</code>的代码供大家参考：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a-list</span> <span class="attr">bordered</span> <span class="attr">:dataSource</span>=<span class="string">"fileList"</span> <span class="attr">:pagination</span>=<span class="string">"pagination"</span> <span class="attr">ref</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">slot</span>=<span class="string">"header"</span> <span class="attr">class</span>=<span class="string">"list-header"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span></span><br><span class="line">        &#123;&#123; filename &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-button</span> <span class="attr">type</span>=<span class="string">"danger"</span> <span class="attr">size</span>=<span class="string">"small"</span> @<span class="attr">click</span>=<span class="string">"clearFiles"</span>&gt;</span></span><br><span class="line">        清空</span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a-list-item</span> <span class="attr">slot</span>=<span class="string">"renderItem"</span> <span class="attr">slot-scope</span>=<span class="string">"item, index"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-list-item-meta</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-tooltip</span> <span class="attr">slot</span>=<span class="string">"title"</span> <span class="attr">:overlayStyle</span>=<span class="string">"&#123; maxWidth: '500px' &#125;"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">template</span> <span class="attr">slot</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">            &#123;&#123; item.name &#125;&#125;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">          &#123;&#123; item.name &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-tooltip</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-list-item-meta</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">ghost</span></span></span><br><span class="line"><span class="tag">        <span class="attr">type</span>=<span class="string">"danger"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">size</span>=<span class="string">"small"</span></span></span><br><span class="line"><span class="tag">        @<span class="attr">click</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">          () =&gt; &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">            delCurrent(index);</span></span></span><br><span class="line"><span class="tag"><span class="string">          &#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">        "</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        删除</span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a-list-item</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">a-list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> &#123; List, Button, Tooltip &#125; <span class="keyword">from</span> <span class="string">"ant-design-vue"</span>;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">const</span> &#123; Item &#125; = List;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">    name: <span class="string">"FileListItem"</span>,</span></span><br><span class="line">    props: &#123;</span><br><span class="line">      fileList: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">Array</span>,</span></span><br><span class="line"><span class="actionscript">        required: <span class="literal">true</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line">      filename: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="actionscript">        required: <span class="literal">true</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line">      pagination: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">Object</span>,</span></span><br><span class="line"><span class="javascript">        <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span></span><br><span class="line">          pageSize: 10,</span><br><span class="line"><span class="actionscript">          showQuickJumper: <span class="literal">true</span>,</span></span><br><span class="line"><span class="actionscript">          hideOnSinglePage: <span class="literal">true</span>,</span></span><br><span class="line">        &#125;),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="actionscript">    inject: [<span class="string">"parent"</span>],</span></span><br><span class="line">    components: &#123;</span><br><span class="line"><span class="actionscript">      <span class="string">"a-list"</span>: List,</span></span><br><span class="line"><span class="actionscript">      <span class="string">"a-list-item"</span>: Item,</span></span><br><span class="line"><span class="actionscript">      <span class="string">"a-list-item-meta"</span>: Item.Meta,</span></span><br><span class="line"><span class="actionscript">      <span class="string">"a-button"</span>: Button,</span></span><br><span class="line"><span class="actionscript">      <span class="string">"a-tooltip"</span>: Tooltip,</span></span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">      delCurrent(current) &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.parent.oldFiles.splice(current, <span class="number">1</span>);</span></span><br><span class="line">      &#125;,</span><br><span class="line">      clearFiles() &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.parent.update(<span class="string">"fileListProps"</span>, <span class="string">"oldFiles"</span>, []);</span></span><br><span class="line">      &#125;,</span><br><span class="line">      drop(e) &#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.parent.update(<span class="string">"fileListProps"</span>, <span class="string">"oldFiles"</span>, [</span></span><br><span class="line">          ...this.parent.oldFiles,</span><br><span class="line">          ...e.dataTransfer.files,</span><br><span class="line">        ]);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    mounted() &#123;</span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> $el = <span class="keyword">this</span>.$refs.list.$el;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.$el = $el;</span></span><br><span class="line">      if ($el) &#123;</span><br><span class="line"><span class="javascript">        $el.ondragenter = $el.ondragover = $el.ondragleave = <span class="function"><span class="params">()</span> =&gt;</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="actionscript">        $el.addEventListener(<span class="string">"drop"</span>, <span class="keyword">this</span>.drop, <span class="literal">false</span>);</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    destroyed() &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.$el &amp;&amp; <span class="keyword">this</span>.$el.removeEventListener(<span class="string">"drop"</span>, <span class="keyword">this</span>.drop, <span class="literal">false</span>);</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">"less"</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.list-header</span> &#123;</span></span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>这里我们看到，可以直接调用<strong>父组件</strong>身上的方法来进行数据的更新（当然这里也可以用<code>splice</code>更新数据），这样也就解决了我们之前的三个问题啦。</p><blockquote><p><code>react</code>，<code>react</code>可是很常用扩展运算符传属性的哦，虽然是<code>jsx</code>都可以 😝 但是我们通过<code>v-bind</code>也可以绑定复杂属性，知识点哦(●’◡’●)</p></blockquote><h4 id="Antd-的坑"><a href="#Antd-的坑" class="headerlink" title="Antd 的坑"></a>Antd 的坑</h4><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames05.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="自定义序号" class="fancybox"><img alt="自定义序号" title="自定义序号" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames05.png" class="lazyload"></a></p><p>因为我自定义序号采用的事弹窗，又因为我们采用的是按需加载，在<code>ant-design-vue@1.6.2</code>版本中会报<strong>Failed to resolve directive: ant-portal</strong>无法解析指令的错误，所以我们需要在<code>main.js</code>中全局注册他，然后因为我们请求可能会用<code>message</code>，所以我顺便也把<code>message</code>放到<code>vue</code>的原型链上了，即：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">"./App.vue"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Message, Modal &#125; <span class="keyword">from</span> <span class="string">"ant-design-vue"</span>;</span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span>;</span><br><span class="line"><span class="keyword">import</span> VueAxios <span class="keyword">from</span> <span class="string">"vue-axios"</span>;</span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span>;</span><br><span class="line">Vue.use(VueAxios, axios);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Failed to resolve directive: ant-portal</span></span><br><span class="line"><span class="comment">// https://github.com/vueComponent/ant-design-vue/issues/2261</span></span><br><span class="line">Vue.use(Modal);</span><br><span class="line">Vue.prototype.$message = Message;</span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  render: <span class="function">(<span class="params">h</span>) =&gt;</span> h(App),</span><br><span class="line">&#125;).$mount(<span class="string">"#app"</span>);</span><br></pre></td></tr></table></figure></div><p>这样子就可以愉快的使用我们的<code>Modal</code>了，然后到了组件选型上了，一开始我选的组件时<code>Form</code>组件，但是写着写着发现我们有个<code>自定义序号</code>和<code>是否启用自定义</code>相关联，而且<code>Form</code>组件如果是必选的话，只能通过<code>v-decorator</code>指令的<code>rules</code>实现绑定数据和必选，不能通过<code>v-model</code>进行数据的双向绑定(不能偷懒)。</p><p>因为我们的<code>ant-design-vue</code>版本已经是<code>1.5.0+</code>，而<code>FormModel</code>组件也支持支持<code>v-model</code>检验，那么就更符合我们的需求啦，所以我这里改了下我的代码，使用<code>FormModel</code>组件实现我们的需求了：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a-modal</span></span></span><br><span class="line"><span class="tag">    <span class="attr">title</span>=<span class="string">"自定义序号"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:visible</span>=<span class="string">"serialNumVisible"</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">cancel</span>=<span class="string">"serialNumVisible = !1"</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">ok</span>=<span class="string">"handleDiySerialNum"</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a-form-model</span></span></span><br><span class="line"><span class="tag">      <span class="attr">ref</span>=<span class="string">"diyForm"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:model</span>=<span class="string">"diyForm"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:rules</span>=<span class="string">"rules"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">labelAlign</span>=<span class="string">"left"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:label-col</span>=<span class="string">"&#123; span: 6 &#125;"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:wrapper-col</span>=<span class="string">"&#123; span: 18 &#125;"</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-form-model-item</span> <span class="attr">label</span>=<span class="string">"自定义序号"</span> <span class="attr">prop</span>=<span class="string">"diySerial"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-input</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-model</span>=<span class="string">"diyForm.diySerial"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">placeholder</span>=<span class="string">"请输入自定义序号"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">aria-placeholder</span>=<span class="string">"请输入自定义序号"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-form-model-item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-form-model-item</span> <span class="attr">label</span>=<span class="string">"自定义分隔符"</span> <span class="attr">prop</span>=<span class="string">"separator"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-input</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-model</span>=<span class="string">"diyForm.separator"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">placeholder</span>=<span class="string">"请输入自定义序号分隔符(默认,)"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">aria-placeholder</span>=<span class="string">"请输入自定义序号分隔符"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-form-model-item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-form-model-item</span> <span class="attr">label</span>=<span class="string">"是否启用自定义"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-switch</span> <span class="attr">v-model</span>=<span class="string">"diyForm.diyEnable"</span> <span class="attr">:disabled</span>=<span class="string">"disabled"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-form-model-item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a-form-model</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">a-modal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure></div><blockquote><p>ps：果然，懒人还是推动技术进步的最主要的动力啊 😂</p></blockquote><h4 id="post-请求下载文件"><a href="#post-请求下载文件" class="headerlink" title="post 请求下载文件"></a>post 请求下载文件</h4><p>因为我之前说过，我们后端不想保留返回的<code>zip</code>文件，所以我们是以<code>流(Stream)</code>传递给前端的，那我们怎么实现在个功能呢？</p><p>其实，还是挺简单的。主要是后端设置两个请求头，分别是<code>Content-Type</code>和<code>Content-Disposition</code>，一个告诉浏览器是什么类型，一个是告诉要以附件的形式下载，并指明默认文件名。</p><p><code>Content-Type</code>我想大家都很常见了吧，而且也不用我们处理了，所以这里我们讲讲怎么处理<code>Content-Disposition</code>，即获取默认的文件名，如图所示：</p><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames06.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="Content-Disposition响应头" class="fancybox"><img alt="Content-Disposition响应头" title="Content-Disposition响应头" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames06.png" class="lazyload"></a></p><p>从图可以看出，响应头信息为<code>content-disposition: attachment; filename=&quot;files.zip&quot;</code>。看到这个字符串，我们第一眼可能会想到通过<code>split</code>方法分割<code>=</code>然后下标取<code>1</code>就可以获取文件名了。但是发现了吗？我们获取的文件名是<code>&quot;files.zip&quot;</code>，与我们想要的结果不同，虽然我们可以通过切割来实现获取到<code>files.zip</code>，但是假设有一天服务器返回的不带<code>&quot;</code>就不通用了。</p><p>那怎么办呢？没错啦，就是通过正则并搭配字符串的<code>replace</code>方法来获取啦~~当然，正则不是本篇的重点，所以就不讲正则怎么写了，接下来书写我们的方法：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取content-disposition响应头的默认文件名</span></span><br><span class="line"><span class="keyword">const</span> getFileName = <span class="function">(<span class="params">str</span>) =&gt;</span> str.replace(<span class="regexp">/^.*filename="?([^"]+)"?.*$/</span>, <span class="string">"$1"</span>);</span><br><span class="line"><span class="keyword">const</span> str = <span class="string">`content-disposition: attachment; filename=files.zip`</span>;</span><br><span class="line"><span class="keyword">const</span> doubleStr = <span class="string">`content-disposition: attachment; filename="files.zip"`</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(getFileName(str)); <span class="comment">// files.zip</span></span><br><span class="line"><span class="built_in">console</span>.log(getFileName(doubleStr)); <span class="comment">// files.zip</span></span><br></pre></td></tr></table></figure></div><p>看输出的是不是和预期的一样？如果一样，这里就实现了我们的获取用户名的方法了，主要用到的就是<code>正则</code>和<code>replace</code>的特殊变量名</p><blockquote><p>ps：不知道<code>repalce</code>的<strong>搞基（高级）</strong>用法的请看<a href="https://gatings.cn/2019-01-09/%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%96%B9%E6%B3%95%E7%9A%84%E6%80%BB%E7%BB%93%E5%92%8C%E4%BD%BF%E7%94%A8/#newSubStr-%E7%9A%84%E7%89%B9%E6%AE%8A%E5%8F%98%E9%87%8F%E5%90%8D">请点击我</a>，这里就不阐述啦</p></blockquote><p>当然，写到这里其实如果是<code>get</code>请求，那么浏览器会默认就下载文件了，我们也不用获取文件名。但是我们是<code>post</code>请求，所以我们需要处理这一系列的东西，并且期待<code>responseType</code>是<code>blob</code>类型，所以我们就写一下前端怎么请求后端并下载文件的。</p><p>既然要写前端代码，那么就要先和后端约定接口是什么，这里因为后端也是自己写的，所以我们暂且把接口定义为<code>http://localhost:3000/upload</code>，又因为我们这里<code>vue</code>的端口在<code>8080</code>，肯定会和我们的后端跨域，所以我们需要在<code>vue.config.js</code>，配置一下我们的代理，即：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 静态资源导入的路径</span></span><br><span class="line">  publicPath: <span class="string">"./"</span>,</span><br><span class="line">  <span class="comment">// 输出目录，因为这里我们Node设置本上级public为静态服务</span></span><br><span class="line">  <span class="comment">// 实际设置成koa-static设置batch-front-end/dist为静态目录的话就不要修改了</span></span><br><span class="line">  <span class="comment">// 具体看自己变通</span></span><br><span class="line">  outputDir: <span class="string">"../public"</span>,</span><br><span class="line">  <span class="comment">// 生产环境下不输出.map文件</span></span><br><span class="line">  productionSourceMap: <span class="literal">false</span>,</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    <span class="comment">// 自动打开浏览器</span></span><br><span class="line">    open: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 配置代理</span></span><br><span class="line">    proxy: &#123;</span><br><span class="line">      <span class="string">"/upload"</span>: &#123;</span><br><span class="line">        target: <span class="string">"http://localhost:3000"</span>,</span><br><span class="line">        <span class="comment">// 发送请求头中host会设置成target</span></span><br><span class="line">        changeOrigin: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 路径重写</span></span><br><span class="line">        pathRewrite: &#123;</span><br><span class="line">          <span class="string">"^/upload"</span>: <span class="string">"/upload"</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  css: &#123;</span><br><span class="line">    loaderOptions: &#123;</span><br><span class="line">      less: &#123;</span><br><span class="line">        javascriptEnabled: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><p>这样子我们就可以跨域请求我们的接口啦，既然说到了下载文件，我们就简单看下<code>file-saver</code>是怎么使用的，从<a href="https://www.npmjs.com/package/file-saver" target="_blank" rel="noopener">官方实例</a>来看：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; saveAs &#125; <span class="keyword">from</span> <span class="string">"file-saver"</span>;</span><br><span class="line"><span class="keyword">const</span> blob = <span class="keyword">new</span> Blob([<span class="string">"Hello, world!"</span>], &#123; <span class="attr">type</span>: <span class="string">"text/plain;charset=utf-8"</span> &#125;);</span><br><span class="line">saveAs(blob, <span class="string">"hello world.txt"</span>);</span><br></pre></td></tr></table></figure></div><p>从示例来看，它可以直接保存<code>blob</code>，并指定文件名为<code>hello world.txt</code>，知道这个之后我们就可以书写我们的代码啦：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; saveAs &#125; <span class="keyword">from</span> <span class="string">"file-saver"</span>;</span><br><span class="line"><span class="keyword">this</span>.axios(&#123;</span><br><span class="line">  method: <span class="string">"post"</span>,</span><br><span class="line">  url: <span class="string">"/upload"</span>,</span><br><span class="line">  data,</span><br><span class="line">  <span class="comment">// 重要，告诉浏览器响应的类型为blob</span></span><br><span class="line">  responseType: <span class="string">"blob"</span>,</span><br><span class="line">&#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> disposition = res.headers[<span class="string">"content-disposition"</span>];</span><br><span class="line">    <span class="comment">// 转换为Blob对象</span></span><br><span class="line">    <span class="keyword">let</span> file = <span class="keyword">new</span> Blob([res.data], &#123;</span><br><span class="line">      type: <span class="string">"application/zip"</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 下载文件</span></span><br><span class="line">    saveAs(file, getFileName(disposition));</span><br><span class="line">    <span class="keyword">this</span>.$message.success(<span class="string">"修改成功"</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.$message.error(<span class="string">"发生错误"</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure></div><p>基本上，这样就可以实现下载文件啦，下面是<code>FileSetting.vue</code>源码，仅供参考：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a-row</span> <span class="attr">type</span>=<span class="string">"flex"</span> <span class="attr">:gutter</span>=<span class="string">"16"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a-col</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:key</span>=<span class="string">"key"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:span</span>=<span class="string">"setting.span"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">v-for</span>=<span class="string">"(setting, key) in fileSettings"</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-if</span>=<span class="string">"setting.isNum"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-input-number</span></span></span><br><span class="line"><span class="tag">          <span class="attr">style</span>=<span class="string">"width:100%"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">:placeholder</span>=<span class="string">"setting.placeholder"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">:min</span>=<span class="string">"1"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-model</span>=<span class="string">"setting.value"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-else</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-input</span></span></span><br><span class="line"><span class="tag">          <span class="attr">:placeholder</span>=<span class="string">"setting.placeholder"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-model</span>=<span class="string">"setting.value"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">allowClear</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a-icon</span></span></span><br><span class="line"><span class="tag">            <span class="attr">slot</span>=<span class="string">"prefix"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">:type</span>=<span class="string">"setting.type"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">style</span>=<span class="string">"color:rgba(0,0,0,.25)"</span></span></span><br><span class="line"><span class="tag">          /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-input</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a-col</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a-col</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-button</span> @<span class="attr">click</span>=<span class="string">"serialNumVisible = !0"</span>&gt;</span></span><br><span class="line">        自定义序号</span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a-col</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a-col</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-button</span> <span class="attr">type</span>=<span class="string">"primary"</span> @<span class="attr">click</span>=<span class="string">"handleModify"</span>&gt;</span></span><br><span class="line">        确定修改</span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a-col</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">a-modal</span></span></span><br><span class="line"><span class="tag">      <span class="attr">title</span>=<span class="string">"自定义序号"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:visible</span>=<span class="string">"serialNumVisible"</span></span></span><br><span class="line"><span class="tag">      @<span class="attr">cancel</span>=<span class="string">"serialNumVisible = !1"</span></span></span><br><span class="line"><span class="tag">      @<span class="attr">ok</span>=<span class="string">"handleDiySerialNum"</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-form-model</span></span></span><br><span class="line"><span class="tag">        <span class="attr">ref</span>=<span class="string">"diyForm"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:model</span>=<span class="string">"diyForm"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:rules</span>=<span class="string">"rules"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">labelAlign</span>=<span class="string">"left"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:label-col</span>=<span class="string">"&#123; span: 6 &#125;"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:wrapper-col</span>=<span class="string">"&#123; span: 18 &#125;"</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-form-model-item</span> <span class="attr">label</span>=<span class="string">"自定义序号"</span> <span class="attr">prop</span>=<span class="string">"diySerial"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a-input</span></span></span><br><span class="line"><span class="tag">            <span class="attr">v-model</span>=<span class="string">"diyForm.diySerial"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">placeholder</span>=<span class="string">"请输入自定义序号"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">aria-placeholder</span>=<span class="string">"请输入自定义序号"</span></span></span><br><span class="line"><span class="tag">          /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-form-model-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-form-model-item</span> <span class="attr">label</span>=<span class="string">"自定义分隔符"</span> <span class="attr">prop</span>=<span class="string">"separator"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a-input</span></span></span><br><span class="line"><span class="tag">            <span class="attr">v-model</span>=<span class="string">"diyForm.separator"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">placeholder</span>=<span class="string">"请输入自定义序号分隔符(默认,)"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">aria-placeholder</span>=<span class="string">"请输入自定义序号分隔符"</span></span></span><br><span class="line"><span class="tag">          /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-form-model-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-form-model-item</span> <span class="attr">label</span>=<span class="string">"是否启用自定义"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a-switch</span> <span class="attr">v-model</span>=<span class="string">"diyForm.diyEnable"</span> <span class="attr">:disabled</span>=<span class="string">"disabled"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-form-model-item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-form-model</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a-modal</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">a-row</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">  <span class="meta"><span class="meta-keyword">import</span> &#123;</span></span></span><br><span class="line"><span class="actionscript">    Row <span class="keyword">as</span> ARow,</span></span><br><span class="line"><span class="actionscript">    Col <span class="keyword">as</span> ACol,</span></span><br><span class="line"><span class="actionscript">    Icon <span class="keyword">as</span> AIcon,</span></span><br><span class="line"><span class="actionscript">    Input <span class="keyword">as</span> AInput,</span></span><br><span class="line"><span class="actionscript">    Switch <span class="keyword">as</span> ASwitch,</span></span><br><span class="line"><span class="actionscript">    Button <span class="keyword">as</span> AButton,</span></span><br><span class="line"><span class="actionscript">    InputNumber <span class="keyword">as</span> AInputNumber,</span></span><br><span class="line"><span class="actionscript">    FormModel <span class="keyword">as</span> AFormModel,</span></span><br><span class="line"><span class="javascript">  &#125; <span class="keyword">from</span> <span class="string">"ant-design-vue"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> &#123; saveAs &#125; <span class="keyword">from</span> <span class="string">"file-saver"</span>;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 是否符合默认序号规范</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> &#123; isDefaultSerialNum &#125; <span class="keyword">from</span> <span class="string">"@/utils/regexp"</span>;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">const</span> AFormModelItem = AFormModel.Item;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">  <span class="comment">// 获取content-disposition响应头的默认文件名</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> getFileName = <span class="function">(<span class="params">str</span>) =&gt;</span> str.replace(<span class="regexp">/^.*filename="?([^"]+)"?.*$/</span>, <span class="string">"$1"</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">    name: <span class="string">"FileSetting"</span>,</span></span><br><span class="line">    props: &#123;</span><br><span class="line">      fileSettings: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">Object</span>,</span></span><br><span class="line"><span class="actionscript">        required: <span class="literal">true</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line">      diyForm: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">Object</span>,</span></span><br><span class="line"><span class="actionscript">        required: <span class="literal">true</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    components: &#123;</span><br><span class="line">      ARow,</span><br><span class="line">      ACol,</span><br><span class="line">      AIcon,</span><br><span class="line">      AInput,</span><br><span class="line">      ASwitch,</span><br><span class="line">      AButton,</span><br><span class="line">      AInputNumber,</span><br><span class="line">      AFormModel,</span><br><span class="line">      AFormModelItem,</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="actionscript">    inject: [<span class="string">"parent"</span>],</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 没有自定义序号时不可操作</span></span></span><br><span class="line">    computed: &#123;</span><br><span class="line">      disabled() &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> !<span class="keyword">this</span>.diyForm.diySerial;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    data() &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line">        serialNumVisible: !1,</span><br><span class="line">        rules: &#123;</span><br><span class="line">          diySerial: [</span><br><span class="line">            &#123;</span><br><span class="line"><span class="actionscript">              required: <span class="literal">true</span>,</span></span><br><span class="line"><span class="actionscript">              message: <span class="string">"请输入自定义序号"</span>,</span></span><br><span class="line"><span class="actionscript">              trigger: <span class="string">"blur"</span>,</span></span><br><span class="line">            &#125;,</span><br><span class="line">          ],</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">      handleModify() &#123;</span><br><span class="line"><span class="actionscript">        <span class="comment">// 获取填写的序号</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> serialNum = <span class="keyword">this</span>.fileSettings.serialNum.value;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 当没有启用自定义时，走默认规则</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (isDefaultSerialNum(serialNum) &amp;&amp; !<span class="keyword">this</span>.diyForm.enable) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span> <span class="keyword">this</span>.$message.error(<span class="string">"请输入正确的序号，格式为纯数字或纯字母"</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> &#123; newFiles, oldFiles &#125; = <span class="keyword">this</span>.parent;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> data = <span class="keyword">new</span> FormData();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; oldFiles.length; i++) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">const</span> &#123; name &#125; = newFiles[i];</span></span><br><span class="line"><span class="actionscript">          data.append(<span class="string">"files"</span>, oldFiles[i]);</span></span><br><span class="line"><span class="actionscript">          data.append(<span class="string">"name"</span>, name);</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.axios(&#123;</span></span><br><span class="line"><span class="actionscript">          method: <span class="string">"post"</span>,</span></span><br><span class="line"><span class="actionscript">          url: <span class="string">"/upload"</span>,</span></span><br><span class="line">          data,</span><br><span class="line"><span class="actionscript">          responseType: <span class="string">"blob"</span>,</span></span><br><span class="line">        &#125;)</span><br><span class="line"><span class="javascript">          .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">const</span> disposition = res.headers[<span class="string">"content-disposition"</span>];</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 转换为Blob对象</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> file = <span class="keyword">new</span> Blob([res.data], &#123;</span></span><br><span class="line"><span class="actionscript">              type: <span class="string">"application/zip"</span>,</span></span><br><span class="line">            &#125;);</span><br><span class="line"><span class="actionscript">            <span class="comment">// 下载文件</span></span></span><br><span class="line">            saveAs(file, getFileName(disposition));</span><br><span class="line"><span class="actionscript">            <span class="keyword">this</span>.$message.success(<span class="string">"修改成功"</span>);</span></span><br><span class="line">          &#125;)</span><br><span class="line"><span class="javascript">          .catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">this</span>.$message.error(<span class="string">"发生错误"</span>);</span></span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      handleDiySerialNum() &#123;</span><br><span class="line"><span class="javascript">        <span class="keyword">this</span>.$refs.diyForm.validate(<span class="function">(<span class="params">valid</span>) =&gt;</span> &#123;</span></span><br><span class="line">          if (!valid) &#123;</span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line">          &#125;</span><br><span class="line"><span class="actionscript">          <span class="keyword">this</span>.serialNumVisible = !<span class="number">1</span>;</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>至此，和后端交互的逻辑基本上已经写完了，但是- -我们好像还没有写前端页面的实际逻辑，那么接下来就开始写前端逻辑啦，可能比较啰嗦- -So Sorry😥</p><blockquote><p>ps：webpack 是开发解决跨域问题，线上该跨域还是要跨域，最好的方法是<code>cors</code>或者<code>proxy</code>，再不然就是放在<code>node</code>的静态服务里。</p></blockquote><h2 id="书写前端逻辑"><a href="#书写前端逻辑" class="headerlink" title="书写前端逻辑"></a>书写前端逻辑</h2><p>从之前的图来看，很显然我们的逻辑就是处理<code>新文件列表</code>这个数据，而这个数据则是根据页面其他组件的值来实现的，所以我们之前用了<strong>计算属性</strong>来实现，但是我们逻辑却还没写，所以接下来就是处理这个最重要的逻辑啦。</p><p>不过好像写好了界面，却还没有说，我想实现什么东西，所以简单的说一下我们界面的交互，我们再开始写逻辑吧。</p><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames07.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="前端交互" class="fancybox"><img alt="前端交互" title="前端交互" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames07.png" class="lazyload"></a></p><p>通过图片，我们大概可以知道有这些操作：</p><ol><li><p>我们可以通过输入文件名，批量修改所有的文件名</p></li><li><p>通过序号，让文件名后面添加后缀，默认支持纯数字和纯字母，即输入<code>test1+001</code>则输出<code>test1001</code></p></li><li><p>通过增量，我们可以让文件的后缀加上增量的值，即加设增量为 2，这里的下一个就是<code>test1+00(1+2)</code>，为<code>test1003</code></p></li><li><p>通过输入<code>需要替换的字符-test</code>和<code>替换的字符-测试</code>，把所有文件的名称修改替换为<code>测试1+001</code>，即<code>测试1001</code></p></li><li><p>通过输入<code>需要修改的后缀名-png</code>和<code>替换的字符-txt</code>并打开修改开关，把所有符合<code>png</code>后缀名的都修改为<code>txt</code>，因为这里只有一个，所以修改为<code>测试1001.txt</code>，即<code>test1001.png-&gt;测试1001.png-&gt;测试1001.txt</code></p></li></ol><p>而启用自定义序号之后，还有后续操作，如图所示：</p><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames07.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="启用自定义序号" class="fancybox"><img alt="启用自定义序号" title="启用自定义序号" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames07.png" class="lazyload"></a></p><p><a href="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames07.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="前端交互" class="fancybox"><img alt="前端交互" title="前端交互" data-src="https://cdn.JsDelivr.net/gh/GATING/blog_imgs/2020-07-05/batch-modify-filenames07.png" class="lazyload"></a></p><ol start="6"><li><p>输入<code>g,a,t,i,n,g</code>这个自定义序号化时，我们的序号的值就应该为<code>[&quot;g&quot;, &quot;a&quot;, &quot;t&quot;, &quot;i&quot;, &quot;n&quot;, &quot;g&quot;]</code>中的一个</p></li><li><p>当我们序号为<code>g</code>且增量为<code>2</code>时，第一个文件的后缀为<code>g</code>，第二个为<code>t</code>，因为<code>g</code>为列表的第一个，那么他下一个的就为<code>1+2</code>，即列表的第三个，也就是<code>t</code></p></li><li><p>纯字母分小写和大写，所以这里我们也需要处理一下</p></li><li><p>文件名+后缀名不能为<code>.</code>，因为在 pc 上是创建不了文件的</p></li></ol><p>知道这 9 点后，我们就可以开始写我们的代码啦。其实主要分为几大块：</p><ul><li><p>文件名的处理</p></li><li><p>后缀名的处理</p></li><li><p>自定义序号的处理</p></li></ul><h3 id="思考一下-1"><a href="#思考一下-1" class="headerlink" title="思考一下"></a>思考一下</h3><p>还记得我们之前的目录结构吗？里面有一个<code>utils(工具库)</code>的文件夹，我们就在这里书写我们的方法。</p><p>先思考一下，我们这些都是针对字符串的，那么用什么处理字符串最合适呢？肯定是正则啦。</p><p>首先当然是书写我们常用的正则啦，主要有那么几个：</p><ul><li><p>获取文件名和拓展名</p></li><li><p>判断是不是空字符串，为空不处理</p></li><li><p>文件名+后缀名不能是<code>.</code></p></li><li><p>在没有自定义序号的情况下，是否符合纯字母这种情况，主要用于区分纯数字和纯字母这两种情况</p></li><li><p>是否符合默认序号规范（纯数字或者纯字母）</p></li></ul><p>在<code>utils/regexp.js</code>中写上：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 匹配文件名和拓展名</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> extReg = <span class="regexp">/(.+)(\..+)$/</span>;</span><br><span class="line"><span class="comment">// 是否为空字符串</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isEmpty = <span class="regexp">/^\s*$/</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 整个文件名+后缀名不能是 .</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span></span>&#125; str 文件名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> testDot = <span class="function">(<span class="params">str</span>) =&gt;</span> <span class="regexp">/^\s*\.+\s*$/</span>.test(str);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 序号是否为字母</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span></span>&#125; str 序号</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> testWord = <span class="function">(<span class="params">str</span>) =&gt;</span> <span class="regexp">/^[a-zA-Z]+$/</span>.test(str);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否符合默认序号规范</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>str 序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; object &#125;</span> </span>返回是否符合默认序号规范（纯字母/纯数字）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isDefaultSerialNum = <span class="function">(<span class="params">str</span>) =&gt;</span></span><br><span class="line">  !<span class="regexp">/(^\d+$)|(^[a-zA-Z]+$)/</span>.test(str) &amp;&amp; !isEmpty.test(str);</span><br></pre></td></tr></table></figure></div><p>书写完正则后，就到了我们的<code>utis/helpers.js</code>帮助函数了，帮助函数主要有三个，分别做了三件事：</p><ol><li><p>判断首字母是不是大写，用于区分<code>a</code>和<code>A</code>，因为<code>a</code>和<code>A</code>序号输出的内容完全不同</p></li><li><p>计算默认情况中字母序号和自定义序号的实际值</p></li><li><p>用于转换默认情况中字母序号和自定义序号的值</p></li></ol><p>针对第一点，其实大家应该都知道怎么写了吧，也比较简单，我们直接通过正则就好了：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断是不是大写字母</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>word =&gt; 字母</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; boolean &#125;</span> </span>返回是否大写字母</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isUpper = <span class="function">(<span class="params">word</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="regexp">/^[A-Z]$/</span>.test(word[<span class="number">0</span>]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><p><code>2、3</code>点的话，可能会觉得比较拗口，也比较难理解。不怕，我举个例子你就理解了。</p><p>假设我们是默认是输入的是纯字母的情况，如果输入<code>a</code>，那么输出是不是就是<code>1</code>，即是第一个字母；输入<code>z</code>，则是<code>26</code>。又因为我们最后得到的字符串，所以我们需要把<code>26</code>这个值转换成<code>z</code>，其实就是反着来。</p><p>乍一看，是不是很像<code>26进制</code>转<code>10进制</code>？对的，没错，其实就是<code>26进制转</code>换成<code>10进制</code>。那么我们怎么转换呢？</p><p>然后我们也说过，要把<strong>字母</strong>先转成实际的值，在转换成十进制在进行上面的操作。</p><p>那么怎么计算十进制的值呢？比如<code>baa</code>转成十进制是多少？它的运算规则是这样的<code>baa = 26**2*2 + 26**1*1 + 26**0*1</code>,即<code>1379</code>，知道规则之后，我们就可以写出以下的计算代码，</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建一个连续的整数数组</span></span><br><span class="line"><span class="keyword">import</span> &#123; range &#125; <span class="keyword">from</span> <span class="string">"lodash"</span>;</span><br><span class="line"><span class="comment">// 创建一个[0-25]的数组，并转换为[A-Z]数组供默认字母序号使用</span></span><br><span class="line"><span class="keyword">let</span> convertArr = range(<span class="number">26</span>).map(<span class="function">(<span class="params">i</span>) =&gt;</span> <span class="built_in">String</span>.fromCharCode(<span class="number">65</span> + i));</span><br><span class="line"><span class="keyword">const</span> serialNum = <span class="string">"baa"</span>,</span><br><span class="line">  complement = serialNum.length;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算第n位26进制数的十进制值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>range =&gt; 26进制数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>val =&gt; 当前值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>idx =&gt; 当前的位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123; number &#125;</span> </span>第n位26进制数的十进制值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> calculate = <span class="function">(<span class="params">range, val, idx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> word = range.indexOf(val.toLocaleUpperCase());</span><br><span class="line">  <span class="keyword">return</span> word === <span class="number">-1</span> ? <span class="number">0</span> : (word + <span class="number">1</span>) * <span class="number">26</span> ** idx;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sum = [...serialNum].reduce(</span><br><span class="line">  (res, val, idx) =&gt; res + calculate(convertArr, val, complement - <span class="number">1</span> - idx),</span><br><span class="line">  <span class="number">0</span></span><br><span class="line">);</span><br><span class="line"><span class="built_in">console</span>.log(sum); <span class="comment">// 1379</span></span><br></pre></td></tr></table></figure></div><p>这样子就计算好了我们的值，接下来就是对这个值进行转换为字母了。因为我们不是从 0 开始，而是从 1 开始，所以每一位的时候我们只需要前的位进行减 1 操作即可。</p><blockquote><p>ps: 不知道<code>**</code>幂运算符的，建议看看 es7，比如<code>26 ** 3</code>，它相当于 Math.pow(26,3)，即<code>26 * 26 * 26</code></p></blockquote><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建一个连续的整数数组</span></span><br><span class="line"><span class="keyword">import</span> &#123; range &#125; <span class="keyword">from</span> <span class="string">"lodash"</span>;</span><br><span class="line"><span class="comment">// 创建一个[0-25]的数组，并转换为[A-Z]数组供默认字母序号使用</span></span><br><span class="line"><span class="keyword">let</span> convertArr = range(<span class="number">26</span>).map(<span class="function">(<span class="params">i</span>) =&gt;</span> <span class="built_in">String</span>.fromCharCode(<span class="number">65</span> + i));</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 26进制转换</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; number &#125;</span> </span>num =&gt; 转换的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; array &#125;</span> </span>range =&gt; 转换的编码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; string &#125;</span> </span>返回转换后的字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> convert = <span class="function">(<span class="params">num, range</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> word = <span class="string">""</span>,</span><br><span class="line">    len = range.length;</span><br><span class="line">  <span class="keyword">while</span> (num &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    num--;</span><br><span class="line">    word = range[num % len] + word;</span><br><span class="line">    <span class="comment">// ~~位运算取整</span></span><br><span class="line">    num = ~~(num / len);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> word;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(convert(<span class="number">1379</span>, convertArr)); <span class="comment">// BAA</span></span><br></pre></td></tr></table></figure></div><p>所以最终的<code>utils/helpers.js</code>文件代码如下：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断是不是大写字母</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>word =&gt; 字母</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; boolean &#125;</span> </span>返回是否大写字母</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isUpper = <span class="function">(<span class="params">word</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="regexp">/^[A-Z]$/</span>.test(word[<span class="number">0</span>]);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 进制转换</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; number &#125;</span> </span>num =&gt; 转换的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; array &#125;</span> </span>range =&gt; 转换的编码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; string &#125;</span> </span>返回转换后的字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> convert = <span class="function">(<span class="params">num, range</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 没有range的时候即为数字，数字我们不需要处理</span></span><br><span class="line">  <span class="keyword">if</span> (!range) <span class="keyword">return</span> num;</span><br><span class="line">  <span class="keyword">let</span> word = <span class="string">""</span>,</span><br><span class="line">    len = range.length;</span><br><span class="line">  <span class="keyword">while</span> (num &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    num--;</span><br><span class="line">    word = range[num % len] + word;</span><br><span class="line">    num = ~~(num / len);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> word;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算第n位进制数的十进制值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>range =&gt; 进制数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>val =&gt; 当前值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>idx =&gt; 当前的位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123; number &#125;</span> </span>第n位进制数的十进制值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> calculate = <span class="function">(<span class="params">range, val, idx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> word = range.indexOf(val);</span><br><span class="line">  <span class="keyword">const</span> len = range.length;</span><br><span class="line">  <span class="keyword">return</span> word === <span class="number">-1</span> ? <span class="number">0</span> : (word + <span class="number">1</span>) * len ** idx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><p>这里我把<code>range</code>作为参数传过来我想大家应该能理解吧？因为其实<code>自定义序号</code>和<code>默认的字母序号</code>的处理是一样，所以这里我们直接传入<code>range</code>就可以处理<strong>自定义</strong>和<strong>纯字母</strong>这种情况了。</p><p>无非就是<code>n进制</code>转<code>十进制</code>的操作，计算规则也同理。。。</p><p>不过写到这里，可能要骂我了- -这不就是把<code>baa</code>转为<code>1379</code>，然后再把<code>1379</code>转回<code>BAA</code>，压根就没有做什么操作啊？━━(￣ー￣*|||━━</p><p>小傻瓜，其实不是的，这里我们只是用一个<code>baa</code>作为演示，假设我们有多个文件，不就是需要<strong>它实际的值+增量</strong>来计算了吗，大概就是：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 伪代码...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNewFileList</span>(<span class="params">fileList, serialNum, increment, range</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 起始序号</span></span><br><span class="line">  <span class="keyword">let</span> start = [...serialNum].reduce(</span><br><span class="line">    (res, val, idx) =&gt; res + calculate(convertArr, val, complement - <span class="number">1</span> - idx),</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> fileList.map(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 得出后缀</span></span><br><span class="line">    <span class="keyword">const</span> suffer = convert(start, range);</span><br><span class="line">    <span class="comment">// 根据increment增量自增</span></span><br><span class="line">    start += increment;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...file,</span><br><span class="line">      name: file.name + suffer,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>到这里，我们基本上对序号处理已经完成了，剩下来就是比较简单的了，也就是对<strong>文件名</strong>和<strong>后缀名</strong>进行处理。还记得我们之前定义的正则，接下来我们就是使用它的时候了。</p><h3 id="处理文件名和后缀名"><a href="#处理文件名和后缀名" class="headerlink" title="处理文件名和后缀名"></a>处理文件名和后缀名</h3><p>先书写我们觉得比较容易处理的方法，比如<code>获取文件和文件后缀名</code>和<code>根据指定字符替换文件名</code>，在<code>utils/index.js</code>文件书写如下代码：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; extReg &#125; <span class="keyword">from</span> <span class="string">"./regexp"</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取文件和文件后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>filename 原始文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; array &#125;</span> </span>返回的文件和文件后缀名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> splitFilename = <span class="function">(<span class="params">filename</span>) =&gt;</span></span><br><span class="line">  filename.replace(extReg, <span class="string">"$1,$2"</span>).split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 替换文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>filename 文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>preReplaceWord 需要替换的字符</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>replaceWord 替换的字符</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; string &#125;</span> </span>返回替换后的文件名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> replaceFilename = <span class="function">(<span class="params">filename, preReplaceWord, replaceWord</span>) =&gt;</span></span><br><span class="line">  filename.replace(preReplaceWord, replaceWord);</span><br></pre></td></tr></table></figure></div><p>还记得我们之前的<code>fileSettings</code>这个配置吗？他有很多一个对象，而我们只需要获取到这对象下的<code>value</code>值，但是一个个<strong>解构赋值</strong>比较麻烦，所以我们也可以写一个方法在获取到它的<code>value</code>值在结构赋值，即：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取文件名设置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; Object &#125;</span> </span>fileSettings 文件名设置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getFileSetting = <span class="function">(<span class="params">fileSettings</span>) =&gt;</span></span><br><span class="line">  <span class="built_in">Object</span>.values(fileSettings).map(<span class="function">(<span class="params">setting</span>) =&gt;</span> setting.value);</span><br><span class="line"><span class="keyword">const</span> fileSettings = &#123;</span><br><span class="line">  filename: &#123;</span><br><span class="line">    value: <span class="string">"test"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  serialNum: &#123;</span><br><span class="line">    value: <span class="string">"aaa"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> [filename, serialNum] = getFileSetting(fileSettings);</span><br><span class="line"><span class="built_in">console</span>.log(filename, serialNum); <span class="comment">// test aaa</span></span><br></pre></td></tr></table></figure></div><p>这样子就能很方便的<strong>解构赋值</strong>了,再然后就是根据<strong>输入的后缀名获得新的后缀名</strong>，这里有个暴力的配置，所以单独拿出来讲讲。</p><p>因为我们需要对<code>*</code>这个字符串进行全局的替换，同时也需要对<code>后缀名</code>，比如<code>png</code>；或者<code>点+后缀名</code>，比如<code>.png</code>。这两种情况处理。所以代码是：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; startsWith &#125; <span class="keyword">from</span> <span class="string">"lodash"</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据输入的后缀名，获取修改文件名的的后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; array &#125;</span> </span>fileExt =&gt; 文件后缀名数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; array &#125;</span> </span>[oldExt, newExt] =&gt; 返回文件的后缀名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getFileExt = <span class="function">(<span class="params">fileExt</span>) =&gt;</span></span><br><span class="line">  <span class="comment">// 如果 i 不存在，返回""</span></span><br><span class="line">  <span class="comment">// 如果 i 是以 "." 开头的返回i，即'.png'返回'.png'</span></span><br><span class="line">  <span class="comment">// 如果 i === "*" 的返回i，即'*'返回'*'</span></span><br><span class="line">  <span class="comment">// 如果是 i 是 'png'，则返回 '.png'</span></span><br><span class="line">  fileExt.map(<span class="function">(<span class="params">i</span>) =&gt;</span></span><br><span class="line">    i ? (startsWith(i, <span class="string">"."</span>) || i === <span class="string">"*"</span> ? i : <span class="string">"."</span> + i) : <span class="string">""</span></span><br><span class="line">  );</span><br></pre></td></tr></table></figure></div><blockquote><p>ps：提一点，如果不知道<code>startsWith</code>这个方法的，建议阅读<a href="https://gatings.cn/2019-01-09/%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%96%B9%E6%B3%95%E7%9A%84%E6%80%BB%E7%BB%93%E5%92%8C%E4%BD%BF%E7%94%A8/#startsWith">字符串的方法的总结和使用</a>，当然我这里用的是<code>lodash</code>的<code>startsWith</code>，但实际上一样的</p></blockquote><p>这里代码翻译成中文就是：</p><ol><li><p>如果<code>后缀名</code>不存在，返回<code>&quot;&quot;(空字符串)</code></p></li><li><p>如果<code>后缀名</code>是以<code>.</code>开头的返回<code>后缀名</code>，即<code>.png</code>返回<code>.png</code></p></li><li><p>如果<code>后缀名</code>是<code>*</code> 的返回<code>*</code>，即<code>*</code>返回<code>*</code></p></li><li><p>如果是<code>后缀名</code>不是以<code>.</code>开头的返回<code>png</code>，则返回<code>.png</code></p></li></ol><p>写完获取<code>后缀名</code>之后就是修改啦，这里单独拿出来谈主要也是因为有个小坑，因为有些文件比较奇葩，他是<code>.+名字</code>，比如我们常常见到的<code>.gitignore</code>文件</p><p>所以我们需要针对这种<code>.+名字</code>这类型的文件进行一个区分，即没有<code>后缀名</code>的文件的处理：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取修改后的后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>fileExt =&gt; 匹配的文件后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>oldExt =&gt; 所有文件后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>newExt =&gt; 修改后文件后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; boolean &#125;</span> </span>enable =&gt; 是否启用修改后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; string &#125;</span> </span>返回修改后的后缀名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getNewFileExt = <span class="function">(<span class="params">fileExt, oldExt, newExt, enable</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> ((oldExt === <span class="string">"*"</span> || fileExt === oldExt) &amp;&amp; enable) &#123;</span><br><span class="line">    <span class="keyword">return</span> newExt;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 避免没有后缀名的bug，比如 .gitignore</span></span><br><span class="line">    <span class="keyword">return</span> fileExt || <span class="string">""</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><p>写到这里，基本上逻辑要写完了，但是还有一个最最最小的问题，就是他可能会输入<code>001</code>，而我们之前的代码会把<code>001</code>转为数字，即会直接转为<code>1</code>。这不是我们想要的，那么我们怎么让他还是字符串形式，但是还是按照数字计算呢？</p><blockquote><p>ps：因为转换值需要+增量，不可能用字符串相加的，所以必须转成数字</p></blockquote><p>所以这里就要需要用到<code>es6</code>的<code>padStart</code>方法啦，通过他来进行<code>序号</code>的补位，然后把之前的方法整理下，定义为<code>getOptions</code>函数，获取通用的配置：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; range, padStart &#125; <span class="keyword">from</span> <span class="string">"lodash"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; testWord &#125; <span class="keyword">from</span> <span class="string">"./regexp"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; calculate, isUpper &#125; <span class="keyword">from</span> <span class="string">"./helpers"</span>;</span><br><span class="line"><span class="keyword">let</span> convertArr = range(<span class="number">26</span>).map(<span class="function">(<span class="params">i</span>) =&gt;</span> <span class="built_in">String</span>.fromCharCode(<span class="number">65</span> + i));</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  获取起始位置、补位字符和自定义数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>serialNum 文件序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; number &#125;</span> </span>complement 需要补的位数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; array &#125;</span> </span>range 自定义序号数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; object &#125;</span> </span>返回起始位置、补位字符和自定义数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getOptions = <span class="function">(<span class="params">serialNum, complement, range</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 起始序号的值，补位序号</span></span><br><span class="line">  <span class="keyword">let</span> start, padNum;</span><br><span class="line">  <span class="comment">// 字母和自定义序号的情况</span></span><br><span class="line">  <span class="keyword">if</span> (testWord(serialNum) || range) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!range) &#123;</span><br><span class="line">      <span class="comment">// 转换大小写</span></span><br><span class="line">      <span class="keyword">if</span> (!isUpper(serialNum[<span class="number">0</span>])) &#123;</span><br><span class="line">        convertArr = convertArr.map(<span class="function">(<span class="params">str</span>) =&gt;</span> str.toLocaleLowerCase());</span><br><span class="line">      &#125;</span><br><span class="line">      range = convertArr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 补位字符</span></span><br><span class="line">    padNum = range[<span class="number">0</span>];</span><br><span class="line">    start = [...serialNum].reduce(</span><br><span class="line">      (res, val, idx) =&gt; res + calculate(range, val, complement - <span class="number">1</span> - idx),</span><br><span class="line">      <span class="number">0</span></span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 纯数字的情况</span></span><br><span class="line">    start = serialNum ? ~~serialNum : <span class="literal">NaN</span>;</span><br><span class="line">    <span class="comment">// 补位字符</span></span><br><span class="line">    padNum = <span class="string">"0"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    start,</span><br><span class="line">    padNum,</span><br><span class="line">    convertArr: range,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> &#123; start, padNum &#125; = getOptions(<span class="string">"001"</span>, <span class="number">3</span>);</span><br><span class="line"><span class="built_in">console</span>.log(padStart(convert(start) + <span class="string">""</span>, <span class="number">3</span>, padNum)); <span class="comment">// 001</span></span><br></pre></td></tr></table></figure></div><blockquote><p>如果不知道<code>padStart</code>这个方法的，建议阅读<a href="https://gatings.cn/2019-01-09/%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%96%B9%E6%B3%95%E7%9A%84%E6%80%BB%E7%BB%93%E5%92%8C%E4%BD%BF%E7%94%A8/#padStart">字符串的方法的总结和使用</a>，当然我这里用的是<code>lodash</code>的<code>padStart</code>，但实际上一样的</p></blockquote><p>写好这一对方法之后，我们就可以实现刚刚那个<strong>伪代码</strong>了，而我们最终<code>vue</code>里面也就需要这一个方法，所以直接导出就行了。</p><p><code>utils/index.js</code>最终代码如下：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  extReg,</span><br><span class="line">  testWord,</span><br><span class="line">  isDefaultSerialNum,</span><br><span class="line">  isEmpty,</span><br><span class="line">  testDot,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">"./regexp"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; calculate, isUpper, convert &#125; <span class="keyword">from</span> <span class="string">"./helpers"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; range, padStart, startsWith &#125; <span class="keyword">from</span> <span class="string">"lodash"</span>;</span><br><span class="line"><span class="comment">// 创建一个[0-25]的数组，并转换为[A-Z]数组供默认字母序号使用</span></span><br><span class="line"><span class="keyword">let</span> convertArr = range(<span class="number">26</span>).map(<span class="function">(<span class="params">i</span>) =&gt;</span> <span class="built_in">String</span>.fromCharCode(<span class="number">65</span> + i));</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取修改后的后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>fileExt =&gt; 匹配的文件后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>oldExt =&gt; 所有文件后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>newExt =&gt; 修改后文件后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; boolean &#125;</span> </span>enable =&gt; 是否启用修改后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; string &#125;</span> </span>返回修改后的后缀名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getNewFileExt = <span class="function">(<span class="params">fileExt, oldExt, newExt, enable</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> ((oldExt === <span class="string">"*"</span> || fileExt === oldExt) &amp;&amp; enable) &#123;</span><br><span class="line">    <span class="keyword">return</span> newExt;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 避免没有后缀名的bug</span></span><br><span class="line">    <span class="keyword">return</span> fileExt || <span class="string">""</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据输入的后缀名，获取修改文件名的的后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; array &#125;</span> </span>fileExt =&gt; 文件后缀名数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; array &#125;</span> </span>[oldExt, newExt] =&gt; 返回文件的后缀名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getFileExt = <span class="function">(<span class="params">fileExt</span>) =&gt;</span></span><br><span class="line">  <span class="comment">// 如果 i 不存在，返回""</span></span><br><span class="line">  <span class="comment">// 如果 i 是以 "." 开头的返回i，即'.png'返回'.png'</span></span><br><span class="line">  <span class="comment">// 如果 i === "*" 的返回i，即'*'返回'*'</span></span><br><span class="line">  <span class="comment">// 如果是 i 是 'png'，则返回 '.png'</span></span><br><span class="line">  fileExt.map(<span class="function">(<span class="params">i</span>) =&gt;</span></span><br><span class="line">    i ? (startsWith(i, <span class="string">"."</span>) || i === <span class="string">"*"</span> ? i : <span class="string">"."</span> + i) : <span class="string">""</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取文件和文件后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>filename 原始文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; array &#125;</span> </span>返回的文件和文件后缀名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> splitFilename = <span class="function">(<span class="params">filename</span>) =&gt;</span></span><br><span class="line">  filename.replace(extReg, <span class="string">"$1,$2"</span>).split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 替换文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>filename 文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>preReplaceWord 需要替换的字符</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>replaceWord 替换的字符</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; string &#125;</span> </span>返回替换后的文件名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> replaceFilename = <span class="function">(<span class="params">filename, preReplaceWord, replaceWord</span>) =&gt;</span></span><br><span class="line">  filename.replace(preReplaceWord, replaceWord);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取文件名设置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; Object &#125;</span> </span>fileSettings 文件名设置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getFileSetting = <span class="function">(<span class="params">fileSettings</span>) =&gt;</span></span><br><span class="line">  <span class="built_in">Object</span>.values(fileSettings).map(<span class="function">(<span class="params">setting</span>) =&gt;</span> setting.value);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  获取起始位置、补位字符和自定义数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>serialNum 文件序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; number &#125;</span> </span>complement 需要补的位数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; array &#125;</span> </span>range 自定义序号数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; object &#125;</span> </span>返回起始位置、补位字符和自定义数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getOptions = <span class="function">(<span class="params">serialNum, complement, range</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 起始序号的值，补位序号</span></span><br><span class="line">  <span class="keyword">let</span> start, padNum;</span><br><span class="line">  <span class="comment">// 字母和自定义序号的情况</span></span><br><span class="line">  <span class="keyword">if</span> (testWord(serialNum) || range) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!range) &#123;</span><br><span class="line">      <span class="comment">// 转换大小写</span></span><br><span class="line">      <span class="keyword">if</span> (!isUpper(serialNum[<span class="number">0</span>])) &#123;</span><br><span class="line">        convertArr = convertArr.map(<span class="function">(<span class="params">str</span>) =&gt;</span> str.toLocaleLowerCase());</span><br><span class="line">      &#125;</span><br><span class="line">      range = convertArr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 补位字符</span></span><br><span class="line">    padNum = range[<span class="number">0</span>];</span><br><span class="line">    start = [...serialNum].reduce(</span><br><span class="line">      (res, val, idx) =&gt; res + calculate(range, val, complement - <span class="number">1</span> - idx),</span><br><span class="line">      <span class="number">0</span></span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 纯数字的情况</span></span><br><span class="line">    start = serialNum ? ~~serialNum : <span class="literal">NaN</span>;</span><br><span class="line">    <span class="comment">// 补位字符</span></span><br><span class="line">    padNum = <span class="string">"0"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    start,</span><br><span class="line">    padNum,</span><br><span class="line">    convertArr: range,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>filename 旧文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>newFilename 新文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; string &#125;</span> </span>返回最终的文件名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getFileName = <span class="function">(<span class="params">filename, newFilename</span>) =&gt;</span></span><br><span class="line">  isEmpty.test(newFilename) ? filename : newFilename;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据配置，获取修改后的文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; array &#125;</span> </span>fileList 原文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; object &#125;</span> </span>fileSettings 文件名设置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; array &#125;</span> </span>extArr 修改的后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; boolean &#125;</span> </span>enable 是否启用修改后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; array &#125;</span> </span>修改后的文件名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewFileList</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fileList,</span></span></span><br><span class="line"><span class="function"><span class="params">  fileSettings,</span></span></span><br><span class="line"><span class="function"><span class="params">  extArr,</span></span></span><br><span class="line"><span class="function"><span class="params">  enable,</span></span></span><br><span class="line"><span class="function"><span class="params">  range</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [</span><br><span class="line">    newFilename,</span><br><span class="line">    serialNum,</span><br><span class="line">    increment,</span><br><span class="line">    preReplaceWord,</span><br><span class="line">    replaceWord,</span><br><span class="line">  ] = getFileSetting(fileSettings);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果不符合默认序号规则，则不改名</span></span><br><span class="line">  <span class="keyword">if</span> (isDefaultSerialNum(serialNum) &amp;&amp; !range) &#123;</span><br><span class="line">    <span class="keyword">return</span> fileList;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取文件修改的后缀名</span></span><br><span class="line">  <span class="keyword">const</span> [oldExt, newExt] = getFileExt(extArr);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 补位，比如输入的是001 补位就是00</span></span><br><span class="line">  <span class="keyword">const</span> padLen = serialNum.length;</span><br><span class="line">  <span class="comment">// 获取开始</span></span><br><span class="line">  <span class="keyword">let</span> &#123; start, padNum, convertArr &#125; = getOptions(serialNum, padLen, range);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fileList.map(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 获取文件名和后缀名</span></span><br><span class="line">    <span class="keyword">let</span> [oldFileName, fileExt] = splitFilename(item.name);</span><br><span class="line">    <span class="comment">// 获取修改后的文件名</span></span><br><span class="line">    <span class="keyword">let</span> filename = replaceFilename(</span><br><span class="line">      getFileName(oldFileName, newFilename),</span><br><span class="line">      preReplaceWord,</span><br><span class="line">      replaceWord</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 获取修改后的后缀名</span></span><br><span class="line">    fileExt = getNewFileExt(fileExt, oldExt, newExt, enable);</span><br><span class="line">    <span class="keyword">const</span> suffix =</span><br><span class="line">      (padLen &amp;&amp; padStart(convert(start, convertArr) + <span class="string">""</span>, padLen, padNum)) ||</span><br><span class="line">      <span class="string">""</span>;</span><br><span class="line">    filename += suffix;</span><br><span class="line">    start += increment;</span><br><span class="line">    <span class="comment">// 文件名+后缀名不能是.</span></span><br><span class="line">    <span class="keyword">let</span> name = testDot(filename + fileExt) ? item.name : filename + fileExt;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...item,</span><br><span class="line">      basename: filename,</span><br><span class="line">      name,</span><br><span class="line">      ext: fileExt,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>看到这里，你会发现，我多数方法只做一件事，通常也建议只做一件事（单一职责原则），这样有利于降低代码复杂度和降低维护成本。希望大家也能养成这样的好习惯哦~~ 😁</p><blockquote><p>ps：函数应该做一件事，做好这件事，只做这一件事。 —代码整洁之道</p></blockquote><h2 id="优化相关"><a href="#优化相关" class="headerlink" title="优化相关"></a>优化相关</h2><h3 id="预加载-preload-和预处理-prefetch"><a href="#预加载-preload-和预处理-prefetch" class="headerlink" title="预加载(preload)和预处理(prefetch)"></a>预加载(preload)和预处理(prefetch)</h3><p><code>preload</code>与<code>prefetch</code>不同的地方就是它专注于当前的页面，并以高优先级加载资源，<code>prefetch</code>专注于下一个页面将要加载的资源并以低优先级加载。同时也要注意<code>preload</code>并不会阻塞<code>window</code>的<code>onload</code>事件。</p><p>即<code>preload</code>加载资源一般是当前页面需要的， <code>prefetch</code>一般是其它页面有可能用到的资源。</p><p>明白这点后，就是在<code>vue.config.js</code>写我们的配置了：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// ...一堆之前配置</span></span><br><span class="line">  chainWebpack(config) &#123;</span><br><span class="line">    <span class="comment">// 建议打开预加载，它可以提高第一屏的速度</span></span><br><span class="line">    config.plugin(<span class="string">"preload"</span>).tap(<span class="function"><span class="params">()</span> =&gt;</span> [</span><br><span class="line">      &#123;</span><br><span class="line">        rel: <span class="string">"preload"</span>,</span><br><span class="line">        <span class="comment">// to ignore runtime.js</span></span><br><span class="line">        <span class="comment">// https://github.com/vuejs/vue-cli/blob/dev/packages/@vue/cli-service/lib/config/app.js#L171</span></span><br><span class="line">        fileBlacklist: [<span class="regexp">/\.map$/</span>, /hot-update\.js$/, /runtime\..*\.js$/],</span><br><span class="line">        include: <span class="string">"initial"</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]);</span><br><span class="line">    <span class="comment">// 去除预读取，因为如果页面过多，会造成无意义的请求</span></span><br><span class="line">    config.plugins.delete(<span class="string">"prefetch"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><blockquote><p>ps：优化网站性能的 <code>pre 家族</code>还有<code>dns-prefetch</code>、<code>prerender</code>和<code>preconnect</code>，有兴趣的可以进一步了解</p></blockquote><h3 id="提取-runtime-js"><a href="#提取-runtime-js" class="headerlink" title="提取 runtime.js"></a>提取 runtime.js</h3><p>因为打包生成的<code>runtime.js</code>非常的小，但这个文件又经常会改变，它的<code>http</code>耗时远大于它的执行时间了，所以建议不要将它单独拆包，而是将它内联到我们的<code>index.html</code>之中，那么则需要使用到<code>script-ext-html-webpack-plugin</code>这个插件，我们安装一下，同样是开发依赖<code>-D</code>：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm i script-ext-html-webpack-plugin -D</span><br></pre></td></tr></table></figure></div><p>接下来就是在<code>vue.config.js</code>写我们的配置了：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> isProduction = process.env.NODE_ENV !== <span class="string">"development"</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// ...一堆之前配置</span></span><br><span class="line">  chainWebpack(config) &#123;</span><br><span class="line">     <span class="comment">// 只在生成环境使用</span></span><br><span class="line">     config.when(isProduction, (config) =&gt; &#123;</span><br><span class="line">      <span class="comment">// html-webpack-plugin的增强功能</span></span><br><span class="line">      <span class="comment">// 打包生成的 runtime.js非常的小，但这个文件又经常会改变，它的 http 耗时远大于它的执行时间了，所以建议不要将它单独拆包，而是将它内联到我们的 index.html 之中</span></span><br><span class="line">      <span class="comment">// inline 的name 和你 runtimeChunk 的 name保持一致</span></span><br><span class="line">      config</span><br><span class="line">        .plugin(<span class="string">"ScriptExtHtmlWebpackPlugin"</span>)</span><br><span class="line">        .after(<span class="string">"html"</span>)</span><br><span class="line">        .use(<span class="string">"script-ext-html-webpack-plugin"</span>, [</span><br><span class="line">          &#123;</span><br><span class="line">            inline: <span class="regexp">/runtime\..*\.js$/</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        ])</span><br><span class="line">        .end();</span><br><span class="line">      <span class="comment">// 单独打包runtime</span></span><br><span class="line">      config.optimization.runtimeChunk(<span class="string">"single"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><h3 id="对第三方库进行拆包"><a href="#对第三方库进行拆包" class="headerlink" title="对第三方库进行拆包"></a>对第三方库进行拆包</h3><p>实际上默认我们会将所有的第三方包打包在一个文件上，这样的方式可行吗？实际上肯定是有问题的，因为将第三方库一块打包，只要有一个库我们升级或者引入一个新库，这个文件就会变动,那么这个文件的变动性会很高,并不适合长期缓存，还有一点，我们要提高首页加载速度，第一要务是减少首页加载依赖的代码量，所以我们需要第三方库进行拆包。</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  publicPath: <span class="string">"./"</span>,</span><br><span class="line">  outputDir: <span class="string">"../public"</span>,</span><br><span class="line">  productionSourceMap: <span class="literal">false</span>,</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    open: <span class="literal">true</span>,</span><br><span class="line">    proxy: &#123;</span><br><span class="line">      <span class="string">"/upload"</span>: &#123;</span><br><span class="line">        target: <span class="string">"http://localhost:3000"</span>,</span><br><span class="line">        changeOrigin: <span class="literal">true</span>,</span><br><span class="line">        pathRewrite: &#123;</span><br><span class="line">          <span class="string">"^/upload"</span>: <span class="string">"/upload"</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  css: &#123;</span><br><span class="line">    loaderOptions: &#123;</span><br><span class="line">      less: &#123;</span><br><span class="line">        javascriptEnabled: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  chainWebpack(config) &#123;</span><br><span class="line">      <span class="comment">// 拆分模块</span></span><br><span class="line">      config.optimization.splitChunks(&#123;</span><br><span class="line">        chunks: <span class="string">"all"</span>,</span><br><span class="line">        cacheGroups: &#123;</span><br><span class="line">          libs: &#123;</span><br><span class="line">            name: <span class="string">"chunk-libs"</span>, <span class="comment">// 输出名字</span></span><br><span class="line">            test: <span class="regexp">/[\\/]node_modules[\\/]/</span>, <span class="comment">// 匹配目录</span></span><br><span class="line">            priority: <span class="number">10</span>, <span class="comment">// 优先级</span></span><br><span class="line">            chunks: <span class="string">"initial"</span>, <span class="comment">// 从入口模块进行拆分</span></span><br><span class="line">          &#125;,</span><br><span class="line">          antDesign: &#123;</span><br><span class="line">            name: <span class="string">"chunk-antd"</span>, <span class="comment">// 将antd拆分为单个包</span></span><br><span class="line">            priority: <span class="number">20</span>, <span class="comment">// 权重需要大于libs和app，否则将打包成libs或app</span></span><br><span class="line">            test: <span class="regexp">/[\\/]node_modules[\\/]_?ant-design-vue(.*)/</span>, <span class="comment">// 为了适应cnpm</span></span><br><span class="line">          &#125;,</span><br><span class="line">          commons: &#123;</span><br><span class="line">            name: <span class="string">"chunk-commons"</span>,</span><br><span class="line">            test: resolve(<span class="string">"src/components"</span>),</span><br><span class="line">            minChunks: <span class="number">3</span>,</span><br><span class="line">            priority: <span class="number">5</span>,</span><br><span class="line">            reuseExistingChunk: <span class="literal">true</span>, <span class="comment">// 复用其他chunk内已拥有的模块</span></span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><h3 id="其他优化"><a href="#其他优化" class="headerlink" title="其他优化"></a>其他优化</h3><p>当然其实还有很多的优化方式，我们这里没有提及，比如：</p><ol><li><p>(伪)服务端渲染，通过<code>prerender-spa-plugin</code>在本地模拟浏览器环境,预先执行我们的打包文件,这样通过解析就可以获取首屏的 HTML,在正常环境中,我们就可以返回预先解析好的 HTML 了。</p></li><li><p>FMP(首次有意义绘制)，通过<code>vue-skeleton-webpack-plugin</code>制作一份<code>Skeleton</code>骨架屏</p></li><li><p>使用<code>cdn</code></p></li><li><p>其它等等…</p></li></ol><h1 id="编写后端"><a href="#编写后端" class="headerlink" title="编写后端"></a>编写后端</h1><p>最后，到了编写后端了，为了符合<code>MVC</code>的开发模式，这里我们创建了<code>controllers</code>文件夹处理我们的业务逻辑，具体目录结构如下：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">|-- batch-modify-filenames</span><br><span class="line">    ├─batch-front-end     # 前端页面</span><br><span class="line">    ├─utils               # 工具库</span><br><span class="line">    |   └index.js</span><br><span class="line">    ├─uploads             # 存放用户上传的文件</span><br><span class="line">    ├─routes              # 后端路由（接口）</span><br><span class="line">    |   ├─index.js        # 路由入口文件</span><br><span class="line">    |   └upload.js        # 上传接口路由</span><br><span class="line">    ├─controllers         # 接口控制器，处理据具体操作</span><br><span class="line">    |      └upload.js     # 上传接口控制器</span><br><span class="line">    ├─package.json        # 依赖文件</span><br><span class="line">    ├─package-lock.json   # 依赖文件版本锁</span><br><span class="line">    ├─app.js              # 启动文件</span><br></pre></td></tr></table></figure></div><p>因为这次我们的后端只有一个接口，而<code>koa-router</code>的使用也十分简单，所以我只会讲我觉得相对有用的东西 （；´д ｀）ゞ（因为再讲下去，篇幅就太长了）</p><h2 id="路由的使用"><a href="#路由的使用" class="headerlink" title="路由的使用"></a>路由的使用</h2><p><code>koa-router</code>使用非常简单，我们在<code>routes/upload.js</code>书写如下代码：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 导入控制器</span></span><br><span class="line"><span class="keyword">const</span> &#123; upload &#125; = <span class="built_in">require</span>(<span class="string">"../controllers/upload"</span>);</span><br><span class="line"><span class="comment">// 导入路由</span></span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">"koa-router"</span>);</span><br><span class="line"><span class="comment">// 设置路由前缀为 upload</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router(&#123;</span><br><span class="line">  prefix: <span class="string">"/upload"</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// post请求，请求地址为 ip + 前缀 + '/'，即'/upload/'</span></span><br><span class="line">router.post(<span class="string">"/"</span>, upload);</span><br><span class="line"><span class="comment">// 导出路由</span></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure></div><p>这样子就是写了一个接口了，你可以先将<code>upload</code>理解为一个空方法，什么都不做，只返回<code>请求成功</code>,即<code>ctx.body=&quot;请求成功&quot;</code></p><blockquote><p>上文中间件那里有说，<code>upload</code>的第一个参数为<code>上下文</code>，不理解的翻阅前面内容。</p></blockquote><p>为了方便以后我们导入接口，而不需要每个<code>route</code>都调用一次<code>app.use(route.routes()).use(route.allowedMethods())</code>，我在<code>routes/index.js</code>（即入口文件），书写了一个方法，让他可以自动引入除<code>index.js</code>的其他文件，之后我们只需要新建接口文件就可以而不需要我们手动导入了，代码如下：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; resolve &#125; = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="comment">// 用于获取文件</span></span><br><span class="line"><span class="keyword">const</span> glob = <span class="built_in">require</span>(<span class="string">"glob"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 获取当前文件夹下的所有文件，除了自己</span></span><br><span class="line">  glob.sync(resolve(__dirname, <span class="string">"!(index).js"</span>)).forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 添加路由</span></span><br><span class="line">    <span class="keyword">const</span> route = <span class="built_in">require</span>(item);</span><br><span class="line">    app.use(route.routes()).use(route.allowedMethods());</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><h3 id="为啥使用-koa-body-而不是-koa-bodyparser？"><a href="#为啥使用-koa-body-而不是-koa-bodyparser？" class="headerlink" title="为啥使用 koa-body 而不是 koa-bodyparser？"></a>为啥使用 koa-body 而不是 koa-bodyparser？</h3><p>因为<code>koa-bodyparser</code>不支持文件上传，想要文件上传还必须安装<code>koa-multer</code>，所以我们这里直接使用<code>koa-body</code>一劳永逸。</p><h3 id="文件上传优化"><a href="#文件上传优化" class="headerlink" title="文件上传优化"></a>文件上传优化</h3><p>很显然，我们上传的文件都在<code>uploads</code>目录下，如果日积月累，这个目录文件会越来越多。但同一目录下文件数量过多的时候，就会影响文件读写性能，这样子是我们最不想看到的了。那么有没有什么方法可以优化这个问题呢？当然是有的，我们可以在文件上传前的进行一些操作，比如<strong>根据日期</strong>创建文件夹，然后把文件保存在<strong>当前日期</strong>的文件夹下。</p><p>这样既可以保证性能，又不会导致文件夹的层次过深。而<code>koa-body</code>刚到又有提供<code>onFileBegin</code>这个函数来实现我们的需求，闲话不多说了，开始写代码吧</p><blockquote><p>ps：不建议层次太深，如果层次过深也会影响性能的- -</p></blockquote><p>为了更好的实现我们的需求，我们需要封装了两个基本的工具方法。</p><ol><li><p>根据日期，生成文件夹名称</p></li><li><p>检查文件夹路径是否存在，如果不存在则创建文件夹</p></li></ol><p>即<code>utils/index.js</code>代码如下：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成文件夹名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getUploadDirName = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="keyword">let</span> month = date.getMonth() + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;date.getFullYear()&#125;</span><span class="subst">$&#123;month&#125;</span><span class="subst">$&#123;date.getDate()&#125;</span>`</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 确定目录是否存在， 如果不存在则创建目录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>pathStr =&gt; 文件夹路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> confirmPath = <span class="function">(<span class="params">dirname</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fs.existsSync(dirname)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (confirmPath(path.dirname(dirname))) &#123;</span><br><span class="line">      fs.mkdirSync(dirname);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getUploadDirName,</span><br><span class="line">  confirmPath,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><p>写完工具函数后，我们就可以处理我们的<code>koa-body</code>这个中间件啦，具体代码如下：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="comment">// uuid，生成不重复的文件名</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">v4</span>: uuid &#125; = <span class="built_in">require</span>(<span class="string">"uuid"</span>);</span><br><span class="line"><span class="comment">// 工具函数</span></span><br><span class="line"><span class="keyword">const</span> &#123; getUploadDirName, confirmPath &#125; = <span class="built_in">require</span>(<span class="string">"./utils/"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="comment">// 解析post请求，</span></span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">"koa-body"</span>);</span><br><span class="line"><span class="comment">// 处理post请求的中间件</span></span><br><span class="line">app.use(</span><br><span class="line">  koaBody(&#123;</span><br><span class="line">    multipart: <span class="literal">true</span>, <span class="comment">// 支持文件上传</span></span><br><span class="line">    formidable: &#123;</span><br><span class="line">      maxFieldsSize: <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>, <span class="comment">// 设置上传文件大小最大限制，默认2M</span></span><br><span class="line">      keepExtensions: <span class="literal">true</span>, <span class="comment">// 保持拓展名</span></span><br><span class="line">      uploadDir: resolve(__dirname, <span class="string">`uploads`</span>),</span><br><span class="line">      <span class="comment">// 文件上传前的一些设置操作</span></span><br><span class="line">      onFileBegin(name, file) &#123;</span><br><span class="line">        <span class="comment">// 生成文件夹</span></span><br><span class="line">        <span class="comment">// 最终要保存到的文件夹目录</span></span><br><span class="line">        <span class="keyword">const</span> dirName = getUploadDirName();</span><br><span class="line">        <span class="comment">// 生成文件名</span></span><br><span class="line">        <span class="keyword">const</span> fileName = uuid();</span><br><span class="line">        <span class="keyword">const</span> dir = resolve(__dirname, <span class="string">`uploads/<span class="subst">$&#123;dirName&#125;</span>`</span>);</span><br><span class="line">        <span class="comment">// 检查文件夹是否存在如果不存在则新建文件夹</span></span><br><span class="line">        confirmPath(dir);</span><br><span class="line">        <span class="comment">// 重新覆盖 file.path 属性</span></span><br><span class="line">        file.path = join(dir, fileName);</span><br><span class="line">        <span class="comment">// 便于后续中间件使用</span></span><br><span class="line">        <span class="comment">// app.context.uploadPath = `$&#123;dirName&#125;/$&#123;fileName&#125;`;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></div><blockquote><p>ps： 针对于<code>uuid</code>的版本问题，建议看：<a href="https://www.zhihu.com/question/34876910" target="_blank" rel="noopener">UUID 是如何保证唯一性的？</a>，这里我们使用的是<code>v4</code>版本，也是最常用的一个版本。。</p></blockquote><h2 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h2><p>和之前讲的一样，后端只需要设置<code>Content-Type</code>和<code>Content-Disposition</code>这两个响应头就可以实现下载了。但是<code>archiver</code>这个库搭配<code>Koa</code>返回流给前端，确实让我措手不及。</p><p>我参考了官方<a href="https://github.com/archiverjs/node-archiver/blob/master/examples/express.js" target="_blank" rel="noopener">Express 这个例子</a>，但是发现在<code>Koa</code>身上不顶用，于是我就- -一直翻<code>issue</code>，发现很多人和我有同样的问题，最后终于在<code>stackoverflow</code>找到了想要的答案。我们可以通过<code>new Stream.PassThrough()</code>创建一个双向流，让<code>archiver</code>通过<code>pipe</code>把数据流写入到<code>双向流</code>里，再通过<code>Koa</code>返回给前端即可，具体实现如下（<code>controllers/upload.js</code>）：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 压缩文件</span></span><br><span class="line"><span class="keyword">const</span> archiver = <span class="built_in">require</span>(<span class="string">"archiver"</span>);</span><br><span class="line"><span class="keyword">const</span> Stream = <span class="built_in">require</span>(<span class="string">"stream"</span>);</span><br><span class="line"><span class="comment">// 判断是否为数组，如果不是，则转为数组</span></span><br><span class="line"><span class="keyword">const</span> isArray = <span class="function">(<span class="params">arr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    arr = [arr];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 上传接口</span></span><br><span class="line">exports.upload = <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 获取上传的文件</span></span><br><span class="line">  <span class="keyword">let</span> &#123; files &#125; = ctx.request.files;</span><br><span class="line">  <span class="comment">// 获取上传的文件名</span></span><br><span class="line">  <span class="keyword">let</span> filenames = isArray(ctx.request.body.name);</span><br><span class="line">  <span class="comment">// 将文件转为数组</span></span><br><span class="line">  files = isArray(files);</span><br><span class="line">  <span class="comment">// 设置响应头，告诉浏览器我要下载的文件叫做files.zip</span></span><br><span class="line">  <span class="comment">// attachment用于浏览器文件下载</span></span><br><span class="line">  ctx.attachment(<span class="string">"files.zip"</span>);</span><br><span class="line">  <span class="comment">// 设置响应头的类型</span></span><br><span class="line">  ctx.set(&#123; <span class="string">"Content-Type"</span>: <span class="string">"application/zip"</span> &#125;);</span><br><span class="line">  <span class="comment">// 定义一个双向流</span></span><br><span class="line">  <span class="keyword">const</span> stream = <span class="keyword">new</span> Stream.PassThrough();</span><br><span class="line">  <span class="comment">// 把流返回给前端</span></span><br><span class="line">  ctx.body = stream;</span><br><span class="line">  <span class="comment">// 压缩成zip</span></span><br><span class="line">  <span class="keyword">const</span> archive = archiver(<span class="string">"zip"</span>, &#123;</span><br><span class="line">    zlib: &#123; <span class="attr">level</span>: <span class="number">9</span> &#125;, <span class="comment">// Sets the compression level.</span></span><br><span class="line">  &#125;);</span><br><span class="line">  archive.pipe(stream);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; files.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> path = files[i].path;</span><br><span class="line">    archive.file(path, &#123; <span class="attr">name</span>: filenames[i] &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  archive.finalize();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><p>这个处理也特别简单，就是根据前端传过来的文件名，把文件重命名即可。最后我们整理一下，<code>app.js</code>的代码如下：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand code-closed" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; resolve, join &#125; = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="comment">// 解析post请求，</span></span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">"koa-body"</span>);</span><br><span class="line"><span class="comment">// 静态服务器</span></span><br><span class="line"><span class="keyword">const</span> serve = <span class="built_in">require</span>(<span class="string">"koa-static"</span>);</span><br><span class="line"><span class="comment">// uuid，生成不重复的文件名</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">v4</span>: uuid &#125; = <span class="built_in">require</span>(<span class="string">"uuid"</span>);</span><br><span class="line"><span class="comment">// 工具函数</span></span><br><span class="line"><span class="keyword">const</span> &#123; getUploadDirName, confirmPath &#125; = <span class="built_in">require</span>(<span class="string">"./utils/"</span>);</span><br><span class="line"><span class="comment">// 初始化路由</span></span><br><span class="line"><span class="keyword">const</span> initRoutes = <span class="built_in">require</span>(<span class="string">"./routes"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理post请求的中间件</span></span><br><span class="line">app.use(</span><br><span class="line">  koaBody(&#123;</span><br><span class="line">    multipart: <span class="literal">true</span>, <span class="comment">// 支持文件上传</span></span><br><span class="line">    formidable: &#123;</span><br><span class="line">      maxFieldsSize: <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>, <span class="comment">// 设置上传文件大小最大限制，默认2M</span></span><br><span class="line">      keepExtensions: <span class="literal">true</span>, <span class="comment">// 保持拓展名</span></span><br><span class="line">      uploadDir: resolve(__dirname, <span class="string">`uploads`</span>),</span><br><span class="line">      <span class="comment">// 文件上传前的一些设置操作</span></span><br><span class="line">      onFileBegin(name, file) &#123;</span><br><span class="line">        <span class="comment">// 最终要保存到的文件夹目录</span></span><br><span class="line">        <span class="keyword">const</span> dirName = getUploadDirName();</span><br><span class="line">        <span class="keyword">const</span> fileName = uuid();</span><br><span class="line">        <span class="keyword">const</span> dir = resolve(__dirname, <span class="string">`uploads/<span class="subst">$&#123;dirName&#125;</span>`</span>);</span><br><span class="line">        <span class="comment">// 检查文件夹是否存在如果不存在则新建文件夹</span></span><br><span class="line">        confirmPath(dir);</span><br><span class="line">        <span class="comment">// 重新覆盖 file.path 属性</span></span><br><span class="line">        file.path = join(dir, fileName);</span><br><span class="line">        <span class="comment">// 便于后续中间件使用</span></span><br><span class="line">        <span class="comment">// app.context.uploadPath = `$&#123;dirName&#125;/$&#123;fileName&#125;`;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 静态服务器</span></span><br><span class="line">app.use(</span><br><span class="line">  serve(resolve(__dirname, <span class="string">"public"</span>), &#123;</span><br><span class="line">    maxage: <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 初始化路由</span></span><br><span class="line">initRoutes(app);</span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`listen successd`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`服务器运行于 http://localhost:<span class="subst">$&#123;<span class="number">3000</span>&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div><p>到这里，基本上本次本章就结束了。当然，其实我们前端界面还可以做的更加可控一点的，比如我可以修改<code>新文件列表</code>的某个文件，使他可以单独自定义而不根据我们的配置走，而根据用户输入的自定义名称走。不过，这个就留给各位当作小作业啦<del>~</del></p><p>顺便提一嘴，因为我们是在浏览器上操作的，没有操作文件的权限，所以写起来会比较麻烦- -如果用<code>Electron</code>编写的话，就方便多了。😝</p><blockquote><p><a href="https://gitee.com/gating/demo/tree/master/batch-modify-filenames" target="_blank" rel="noopener">gitee 地址</a>,<a href="https://github.com/GATING/demo/tree/master/batch-modify-filenames" target="_blank" rel="noopener">github 地址</a></p></blockquote><h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>感谢各位观众老爷的观看 O(∩_∩)O 希望你能有所收获 😁</p></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">gating</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://gatings.cn/2020-07-05/node%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9(%E6%96%87%E4%BB%B6%E5%90%8D)/">https://gatings.cn/2020-07-05/node%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9(%E6%96%87%E4%BB%B6%E5%90%8D)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://gatings.cn">磨蹭先生</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/vue/">vue </a><a class="post-meta__tags" href="/tags/node/">node</a></div><div class="post_share"></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/GATING/blog_imgs@master/blog/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/GATING/blog_imgs@master/blog/alipay.jpg" alt="支付宝"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020-09-08/JS%E4%B8%AD%E6%9C%89%E8%B6%A3%E7%9A%84%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1-JSON/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror='onerror=null,src="/img/404.jpg"'><div class="label">上一篇</div><div class="prev_info"><span>JS中有趣的内置对象-JSON</span></div></a></div><div class="next-post pull_right"><a href="/2020-06-17/node%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror='onerror=null,src="/img/404.jpg"'><div class="label">下一篇</div><div class="next_info"><span>node实现文件属性批量修改(时间属性)</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020-11-03/Vue+Antd搭配百度地图实现搜索定位等功能/" title="Vue+Antd搭配百度地图实现搜索定位等功能"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-11-03</div><div class="relatedPosts_title">Vue+Antd搭配百度地图实现搜索定位等功能</div></div></a></div><div class="relatedPosts_item"><a href="/2020-03-14/用vue实现一个简单的时间屏幕/" title="用vue实现一个简单的时间屏幕"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-14</div><div class="relatedPosts_title">用vue实现一个简单的时间屏幕</div></div></a></div><div class="relatedPosts_item"><a href="/2020-06-17/node实现文件属性批量修改/" title="node实现文件属性批量修改(时间属性)"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-06-17</div><div class="relatedPosts_title">node实现文件属性批量修改(时间属性)</div></div></a></div><div class="relatedPosts_item"><a href="/2020-06-12/node实现图片尺寸批量修改/" title="node实现批量修改图片尺寸"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-06-12</div><div class="relatedPosts_title">node实现批量修改图片尺寸</div></div></a></div><div class="relatedPosts_item"><a href="/2020-06-10/node图片四周填充透明区域/" title="node实现图片四周填充透明区域"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-06-10</div><div class="relatedPosts_title">node实现图片四周填充透明区域</div></div></a></div><div class="relatedPosts_item"><a href="/2020-03-11/node实现图片分割/" title="node实现图片分割"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-11</div><div class="relatedPosts_title">node实现图片分割</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC8zNTA5MC8xMTYyNQ=="><script>!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script></div></div></div></main><footer id="footer" style="background-image:url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2020 By gating</div><div class="footer_custom_text">由<b>&nbsp;磨蹭&nbsp;</b>倾力打造&nbsp;|&nbsp;<b>女王大人</b>&nbsp;-&nbsp;热情赞助</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments"></i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/click_heart.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49b1f5">hexo-generator-search</a> <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>